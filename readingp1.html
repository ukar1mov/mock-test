<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sevenplus ‚Äî Reading (Passage 1)</title>
<link rel="icon" href="./favicon/favicon-180.png" sizes="32x32">
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<meta name="theme-color" content="#1aa2c9">

<style>
  :root{--brand-blue:#1aa2c9;--brand-gray:#55595c;--bg:#f7f9fb;--panel:#fff;--text:#1b1f23;--line:#e5e8eb}
  [data-theme="dark"]{--bg:#0e1116;--panel:#141922;--text:#e6edf3;--line:#2a2f38}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto}
  .appbar{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;padding:10px 16px;z-index:10}
  .logo-text{font-size:1.2rem;text-decoration:none}
  .meta{margin-left:auto;display:flex;gap:10px;align-items:center}
  .btn{border:1px solid var(--line);background:var(--panel);padding:.55rem .9rem;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--brand-blue);color:#fff;border-color:var(--brand-blue)}
  .btn.ghost{background:transparent}
  .btn.active{background:var(--brand-blue);color:#fff;border-color:var(--brand-blue);pointer-events:none}
  main{max-width:1200px;margin:16px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .toolbar{display:flex;gap:8px;align-items:center;border:1px dashed var(--line);padding:8px;border-radius:10px;margin:10px 0}
  .swatch{width:20px;height:20px;border-radius:4px;border:1px solid var(--line);cursor:pointer}
  .swatch.yellow{background:#fff59d}
  .swatch.green{background:#c8e6c9}
  .swatch.eraser{display:flex;align-items:center;justify-content:center;font-size:14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .panel{min-height:60vh;max-height:calc(100vh - 150px);overflow:auto;border:1px solid var(--line);border-radius:12px;padding:16px;background:var(--panel)}
  h1,h2,h3{margin:.2rem 0}
  .note{color:#667085}
  .qblock{border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
  .options{display:grid;gap:6px;margin-top:8px}
  input[type=text]{width:100%;padding:.5rem .6rem;border:1px solid var(--line);border-radius:10px}
  footer.nav{display:flex;gap:20px;justify-content:center;margin:18px 0}
  footer.nav a{text-decoration:none}
  footer.nav .btn{color:var(--brand-blue);border-radius:14px;font-weight:600;min-width:120px;text-align:center}
  footer.nav .btn.active{background:var(--brand-blue);color:#fff;border-color:var(--brand-blue);pointer-events:none}

  .timer{
    margin-left:8px;padding:.25rem .55rem;border:1px solid var(--line);
    border-radius:10px;background:var(--panel);font-weight:600;color:var(--brand-blue);
    min-width:64px;text-align:center;
  }

  .fill-onecol{width:100%;border:1px solid var(--line);border-radius:8px;border-collapse:separate;border-spacing:0;margin:8px 0}
  .fill-onecol td{border:0;padding:10px 12px;vertical-align:top}
  .fill-onecol input[type=text]{display:inline-block;min-width:120px;max-width:220px}

  .qnav{display:flex;gap:6px;flex-wrap:wrap;margin:12px 0 0 0;padding-top:12px;border-top:1px solid var(--line)}
  .qnav button{
    width:34px;height:34px;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer;
    transition:transform .06s ease, box-shadow .06s ease, background .2s ease, color .2s ease, border-color .2s ease;
  }
  .qnav button:active{transform:scale(.98)}
  .qnav button.answered{background:#4caf50;color:#fff;border-color:#4caf50;box-shadow:0 0 0 2px rgba(76,175,80,.2) inset}
  @keyframes flashGreen{0%{box-shadow:0 0 0 0 rgba(76,175,80,.0)}50%{box-shadow:0 0 0 6px rgba(76,175,80,.35)}100%{box-shadow:0 0 0 0 rgba(76,175,80,.0)}}
  .qnav button.flash{animation:flashGreen .6s ease}

  .hl{display:inline;padding:0;border:0;line-height:inherit;font:inherit}
  .hl-yellow{background-color:#fff59d}
  .hl-green{background-color:#c8e6c9}
</style>
</head>
<body>
<header class="appbar">
  <span class="logo-text"><strong style="color:var(--brand-blue)">seven</strong><strong style="color:var(--brand-gray)">plus</strong></span>
  <span id="timer" class="timer" aria-live="polite">60:00</span>
  <div class="meta">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input id="themeToggle" type="checkbox" />
      <span>üåì</span>
    </label>
  </div>
</header>

<main>
  <div class="card">
    <div class="toolbar"><span>Highlighter:</span>
      <button class="swatch yellow" data-hl="yellow" title="Yellow"></button>
      <button class="swatch green" data-hl="green" title="Green"></button>
      <button class="swatch eraser" id="hl-eraser" title="Eraser">üßΩ</button>
    </div>

    <div class="grid">
      <article id="passage" class="panel" tabindex="0">
        <h2>READING PASSAGE 1</h2>
        <p class="note">You should spend about 20 minutes on Questions 1‚Äì13 which are based on Reading Passage 1.</p>

        <h2 style="text-align:center">Sleep Study on Modern-Day Hunter-Gatherers Dispels Popular Notions</h2>

        <p><strong>A</strong> Modern life‚Äôs sleep troubles ‚Äî the chronic bleary-eyed state that many of us live in ‚Äî have long been blamed on our industrial society. The city lights, long work hours, commutes, caffeine, the Internet. When talking about the miserable state of our ability to get enough rest, sleep researchers have had a tendency to hark back to a simpler time when humans were able to fully recharge by sleeping and waking to the rhythms of the sun. It turns out that may not be quite right. In fact, it now appears that our ancestors may not have been getting the doctor-recommended eight hours of sleep, either.</p>

        <p><strong>B</strong> In an intriguing study published in <em>Current Biology</em>, researchers traveled to remote corners of the planet to scrutinize the sleep patterns of some of the world‚Äôs last remaining hunter-gatherers ‚Äî the Hadza of Tanzania, the San of Namibia, and the Tsimane of Bolivia. Cut off from electricity, media and other distractions, these pre-industrial societies are thought to experience the same sort of natural sleep ancient humans enjoyed more than 10,000 years ago.</p>

        <p><strong>C</strong> Located in a woodland-savannah habitat 2 degrees south of the equator, the Hadza gather their wild foods each day. The San are not migratory but interact very little with surrounding villages and live as hunter-gatherers. The Tsimane, who live close to the Maniqui River and thereby have to live with humid climate, are hunter-horticulturalists. Using Actiwatch-2 devices, a medical-grade Fitbit hand-watch for sleep, researchers recorded the sleeping habits of 94 of these tribespeople and ended up collecting data representing 1,165 days.</p>

        <p><strong>D</strong> What they found was a striking uniformity in their sleep patterns despite their geographic isolation. On average, all three groups sleep a little less than 6.5 hours a night, do not take naps and don‚Äôt go to sleep when it gets dark. Like many of us, the Hadza, San and Tsimane spent more time in bed ‚Äî from 6.9 to 8.5 hours ‚Äî than they do actually sleeping. That computes to a sleep efficiency of between 81 to 86 percent ‚Äî very similar to today‚Äôs industrial populations. Jerome Siegel, director of the University of California at Los Angeles‚Äôs Center for Sleep Research, and his colleagues explained that this suggests that sleep may not be environmental or cultural, but ‚Äúcentral to the physiology of humans‚Äù living in the tropical latitudes where our species evolved.</p>

        <p><strong>E</strong> ‚ÄúThe short sleep in these populations challenges the belief that sleep has been greatly reduced in the ‚Äòmodern world,‚Äô‚Äù Siegel said. ‚ÄúThis has important implications for the idea that we need to take sleeping pills because sleep has been reduced from its ‚Äònatural level‚Äô by the widespread use of electricity, TV, the Internet, and so on.‚Äù The findings call into question the untold millions that have been spent on research that tries to get to the bottom of why ‚Äúshort‚Äù sleepers get only about six hours of sleep a night and the idea that lack of sleep may be a big reason that obesity, mood disorders and other physical and mental ailments have surged in recent decades.</p>

        <p><strong>F</strong> Scientists have long documented that people have a tendency to ‚Äúcrash‚Äù in energy in the mid-afternoon, and some have speculated that it‚Äôs because we‚Äôve managed to suppress some innate need for a siesta. The new study provides evidence that this is unlikely. The data from the San in Namibia, for instance, show no afternoon naps during 210 days of recording in the winter and 10 naps in 364 days in the summer. The findings were similar for the other two tribes, suggesting that napping isn‚Äôt really a common thing among hunter-gatherers, either. At the high end, the researchers estimated that naps may have occurred on up to 7 percent of winter days and 22 percent of summer days. The researchers noted that the devices they were using weren‚Äôt great at picking up naps of short durations, so it is possible that some of the study subjects were taking short power naps of less than 15 minutes.</p>

        <p><strong>G</strong> Another fascinating finding from the study had to do with the circadian rhythms related to sunlight. Instead of going to sleep right at dusk, the hunter-gatherers were sleeping an average of 2.5 and 4.4 hours after sunset ‚Äî well after darkness had fallen. All three tribes had small fires going, but the light itself was much lower than you might get from your average 60-watt bulb. They did, however, have a tendency to wake up around sunrise ‚Äî an hour before or an hour after, depending on the season and the group. Siegel and his co-authors investigated this further by looking into the significance of temperature and found that it may play a big role. The research showed that ‚Äúsleep in both the winter and summer occurred during the period of decreasing ambient temperature and that wake onset occurred near the nadir of the daily temperature rhythm,‚Äù they wrote.</p>

        <p><strong>H</strong> It should be noted that the tribespeople studied are different from your average American in a number of respects. Importantly, very few of the hunter-gatherers suffer from chronic insomnia. There isn‚Äôt even a word for it in their languages. In interviews conducted through interpreters, 1.5 to 2.5 percent of the study subjects said they had sleep onset or sleep maintenance problems more than once a year, which is far lower than the 10 to 30 percent documented in many countries today. Siegel suggested that this may mean that ‚Äúmimicking aspects of the natural environment‚Äù may be effective in treating some sleep disorders.</p>

        <p><strong>I</strong> The hunter-gatherers are also much healthier. Not a single one is obese, and the mean BMIs among the tribes were between 18.3 and 26.2, which is considered quite slim. They also tend to have lower blood pressure, better heart conditions and higher levels of physical fitness. Thus comes a critical question. If we can‚Äôt blame the lack of sleep as causing our obesity, mood disorders and the like, could it be that the reason we feel so unrested is because of poor health?</p>

        <div class="qnav" id="qnav"></div>
      </article>

      <aside id="questions" class="panel" tabindex="0">
        <h3>Questions 1‚Äì6</h3>
        <p>Complete the note. Write <strong>NO MORE THAN TWO WORDS AND/OR A NUMBER</strong> from the text for each answer.</p>

        <div class="qblock">
          <table class="fill-onecol" role="table" aria-label="Questions 1 to 6 inline">
            <tbody>
              <tr>
                <td>Researchers suggest our ancestors may not have obtained the doctor-recommended <input id="R1" type="text" placeholder="1"/> hours of sleep.</td>
              </tr>
              <tr>
                <td>The study was published in the journal <input id="R2" type="text" placeholder="2"/>.</td>
              </tr>
              <tr>
                <td>Subjects wore medical-grade hand-watch devices known as <input id="R3" type="text" placeholder="3"/>.</td>
              </tr>
              <tr>
                <td>In total the team collected data covering <input id="R4" type="text" placeholder="4"/> days.</td>
              </tr>
              <tr>
                <td>On average the groups slept a little less than <input id="R5" type="text" placeholder="5"/> hours a night.</td>
              </tr>
              <tr>
                <td>Their sleep efficiency is similar to today‚Äôs <input id="R6" type="text" placeholder="6"/> populations.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3 style="margin-top:16px">Questions 7‚Äì9</h3>
        <p>Choose the correct answer.</p>

        <div class="qblock" id="Q7">
          <p><strong>7.</strong> Which belief do the findings directly challenge?</p>
          <div class="options">
            <label><input type="radio" name="R7" value="A"> Sleep has been greatly reduced in the modern world.</label>
            <label><input type="radio" name="R7" value="B"> Sleeping pills are never useful.</label>
            <label><input type="radio" name="R7" value="C"> Napping is common among all peoples.</label>
            <label><input type="radio" name="R7" value="D"> Artificial light has increased sleep duration.</label>
          </div>
        </div>

        <div class="qblock" id="Q8">
          <p><strong>8.</strong> What does the new study suggest about an innate need for siestas?</p>
          <div class="options">
            <label><input type="radio" name="R8" value="A"> It has been suppressed by culture.</label>
            <label><input type="radio" name="R8" value="B"> Evidence indicates it is unlikely.</label>
            <label><input type="radio" name="R8" value="C"> Napping is universal among the tribes.</label>
            <label><input type="radio" name="R8" value="D"> The devices showed hundreds of naps.</label>
          </div>
        </div>

        <div class="qblock" id="Q9">
          <p><strong>9.</strong> Regarding timing of sleep and wakefulness, which statement is supported?</p>
          <div class="options">
            <label><input type="radio" name="R9" value="A"> Sleep began during periods of decreasing ambient temperature.</label>
            <label><input type="radio" name="R9" value="B"> Wake onset occurred at the daily temperature maximum.</label>
            <label><input type="radio" name="R9" value="C"> Firelight controlled bedtimes completely.</label>
            <label><input type="radio" name="R9" value="D"> Temperature played no role in sleep timing.</label>
          </div>
        </div>

        <h3 style="margin-top:16px">Questions 10‚Äì13</h3>
        <p>Do the following statements agree with the information given in the text?<br>
        <span class="note">Write <strong>TRUE</strong> / <strong>FALSE</strong> / <strong>NOT GIVEN</strong>.</span></p>

        <div class="qblock" id="Q10">
          <p><strong>10.</strong> The hunter-gatherers slept more than eight hours on average.</p>
          <div class="options">
            <label><input type="radio" name="R10" value="TRUE"> TRUE</label>
            <label><input type="radio" name="R10" value="FALSE"> FALSE</label>
            <label><input type="radio" name="R10" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <div class="qblock" id="Q11">
          <p><strong>11.</strong> The devices used may have failed to detect very short naps.</p>
          <div class="options">
            <label><input type="radio" name="R11" value="TRUE"> TRUE</label>
            <label><input type="radio" name="R11" value="FALSE"> FALSE</label>
            <label><input type="radio" name="R11" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <div class="qblock" id="Q12">
          <p><strong>12.</strong> The tribes typically went to sleep long before sunset.</p>
          <div class="options">
            <label><input type="radio" name="R12" value="TRUE"> TRUE</label>
            <label><input type="radio" name="R12" value="FALSE"> FALSE</label>
            <label><input type="radio" name="R12" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <div class="qblock" id="Q13">
          <p><strong>13.</strong> None of the tribal participants were obese.</p>
          <div class="options">
            <label><input type="radio" name="R13" value="TRUE"> TRUE</label>
            <label><input type="radio" name="R13" value="FALSE"> FALSE</label>
            <label><input type="radio" name="R13" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <footer class="nav" aria-label="Passage navigation">
          <a class="btn active" href="readingp1.html" aria-current="page">Passage 1</a>
          <a class="btn" href="readingp2.html">Passage 2</a>
          <a class="btn" href="readingp3.html">Passage 3</a>
        </footer>
      </aside>
    </div>
  </div>
</main>

<script>
const PAGE_ID='reading_p1';

/* ===== Theme ===== */
const themeToggle=document.getElementById('themeToggle');
if(themeToggle){
  const saved=localStorage.getItem('sp_theme')||'light';
  document.documentElement.setAttribute('data-theme', saved);
  themeToggle.checked = saved==='dark';
  themeToggle.addEventListener('change',()=>{
    const mode=themeToggle.checked?'dark':'light';
    document.documentElement.setAttribute('data-theme', mode);
    localStorage.setItem('sp_theme', mode);
  });
}

/* ===== Highlighter ===== */
function wrapSelection(color){
  const sel=window.getSelection();
  if(!sel || sel.isCollapsed) return;
  const range=sel.getRangeAt(0);
  const span=document.createElement('span');
  span.className = 'hl ' + (color==='yellow' ? 'hl-yellow' : 'hl-green');
  try{ range.surroundContents(span); }catch{}
  sel.removeAllRanges();
}
function eraseSelection(){
  const sel=window.getSelection();
  if(!sel || sel.isCollapsed) return;
  const range=sel.getRangeAt(0);
  document.querySelectorAll('#passage span.hl').forEach(el=>{
    try{
      if(range.intersectsNode(el)){
        const parent=el.parentNode;
        while(el.firstChild) parent.insertBefore(el.firstChild, el);
        parent.removeChild(el);
        parent.normalize();
      }
    }catch{}
  });
  sel.removeAllRanges();
}

document.querySelectorAll('[data-hl]').forEach(b=>b.addEventListener('click',()=>wrapSelection(b.getAttribute('data-hl'))));
document.getElementById('hl-eraser')?.addEventListener('click', eraseSelection);

/* ===== Disable autocomplete/spell suggestions on inputs ===== */
function hardDisableSuggestions(scope=document){
  scope.querySelectorAll('input[type="text"], textarea').forEach(el=>{
    el.setAttribute('autocomplete','off');
    el.setAttribute('autocorrect','off');
    el.setAttribute('autocapitalize','off');
    el.setAttribute('spellcheck','false');
    el.setAttribute('data-lpignore','true');
  });
}
hardDisableSuggestions();

/* ===== Debounced aggregator (saves consolidated objects) ===== */
let aggTimer=null;
function scheduleAggregate(){ clearTimeout(aggTimer); aggTimer=setTimeout(aggregateAllAnswers, 200); }

function snapshotPageToPerInput(){
  document.querySelectorAll('input[type=text], textarea, select').forEach(el=>{
    const id = el.id || el.name; if(!id) return;
    localStorage.setItem('R_'+id, el.value || '');
  });
  const radioNames = new Set();
  document.querySelectorAll('input[type=radio][name^="R"]').forEach(r=>radioNames.add(r.name));
  radioNames.forEach(name=>{
    const checked = document.querySelector('input[type=radio][name="'+name+'"]:checked');
    if(checked) localStorage.setItem('R_'+name, checked.value);
  });
}

function aggregateAllAnswers(){
  // ensure current page values are snapped first
  snapshotPageToPerInput();

  const answers = {};
  for (let i=0; i<localStorage.length; i++){
    const k = localStorage.key(i);
    if(!k || !k.startsWith('R_R')) continue;  // per-input reading keys e.g. R_R1, R_R7
    const id = k.slice(2);                    // -> "R1", "R7"
    answers[id] = localStorage.getItem(k) || '';
  }
  const qmap = {};
  for (let n=1;n<=13;n++) qmap['Q'+n] = answers['R'+n] || '';

  const iso = new Date().toISOString();
  try{
    localStorage.setItem('sp_reading_answers', JSON.stringify(answers));
    localStorage.setItem('sp_reading_answers_q', JSON.stringify(qmap));
    localStorage.setItem('sp_reading_saved_at', iso);
    localStorage.setItem('sp_reading_p1', JSON.stringify({ page: PAGE_ID, savedAt: iso, answers: qmap }));
  }catch{}
}

/* ===== Autosave bindings (restore + save) ===== */
function saveRadios(name){
  const key='R_'+name;
  const saved=localStorage.getItem(key)||'';
  document.querySelectorAll('input[type=radio][name="'+name+'"]').forEach(n=>{
    if(n.value===saved) n.checked=true;
    n.addEventListener('change',()=>{ localStorage.setItem(key,n.value); scheduleAggregate(); });
  });
}
function bindInput(id){
  const el=document.getElementById(id); if(!el) return;
  const k='R_'+id;
  el.value=localStorage.getItem(k)||'';
  el.addEventListener('input',()=>{ localStorage.setItem(k,el.value); scheduleAggregate(); });
  hardDisableSuggestions(el.parentElement || document);
}
['R7','R8','R9','R10','R11','R12','R13'].forEach(nm=>saveRadios(nm));
['R1','R2','R3','R4','R5','R6'].forEach(bindInput);

/* ===== Footer nav should save first, then navigate ===== */
(function(){
  document.querySelectorAll('footer.nav a').forEach(a=>{
    a.addEventListener('click', e=>{
      e.preventDefault();
      aggregateAllAnswers();
      window.location.href = a.getAttribute('href');
    });
  });
})();

/* ===== Question nav (builds 1‚Äì13 and marks answered) ===== */
(function buildQuestionNav(){
  const container = document.getElementById('qnav');
  if(!container) return;

  const keys = new Set();
  document.querySelectorAll('input[type="text"][id^="R"]').forEach(el=>{
    const m = el.id.match(/^R(\d+)$/); if(m) keys.add(m[1]);
  });
  const radioNames = new Set();
  document.querySelectorAll('input[type="radio"][name^="R"]').forEach(el=>radioNames.add(el.name));
  Array.from(radioNames).forEach(n=>{ const m=n.match(/^R(\d+)$/); if(m) keys.add(m[1]); });

  const nums = Array.from(keys).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
  const btnMap = new Map();

  function isAnswered(num){
    const id='R'+num;
    const text=document.getElementById(id);
    if(text && text.type==='text') return (text.value||'').trim().length>0;
    const radios=document.querySelectorAll('input[type="radio"][name="'+id+'"]');
    return radios.length ? Array.from(radios).some(r=>r.checked) : false;
  }
  function mark(num, justAnswered){
    const btn=btnMap.get(num); if(!btn) return;
    const answered=isAnswered(num);
    const was=btn.classList.contains('answered');
    if(answered){
      btn.classList.add('answered');
      if(!was && justAnswered){
        btn.classList.add('flash');
        btn.addEventListener('animationend',()=>btn.classList.remove('flash'),{once:true});
      }
    }else{
      btn.classList.remove('answered'); btn.classList.remove('flash');
    }
  }

  nums.forEach(num=>{
    const b=document.createElement('button');
    b.type='button'; b.textContent=String(num);
    b.addEventListener('click',()=>{
      const id='R'+num;
      const text=document.getElementById(id);
      if(text){ text.scrollIntoView({behavior:'smooth',block:'center'}); text.focus(); }
      else{
        const target=document.querySelector('[name="'+id+'"]') || document.getElementById('Q'+num);
        if(target){ (target.closest('.qblock')||target).scrollIntoView({behavior:'smooth',block:'center'}); if(target.focus) target.focus(); }
      }
    });
    container.appendChild(b);
    btnMap.set(num,b);
  });

  nums.forEach(num=>{
    const id='R'+num;
    const text=document.getElementById(id);
    if(text && text.type==='text'){ text.addEventListener('input',()=>mark(num,true)); mark(num,false); }
    else{
      const radios=document.querySelectorAll('input[type="radio"][name="'+id+'"]');
      if(radios.length){ radios.forEach(r=>r.addEventListener('change',()=>mark(num,true))); mark(num,false); }
    }
  });

  window.addEventListener('pageshow', ()=>nums.forEach(n=>mark(n,false)));
})();

/* ===== Ensure timer badge exists ===== */
(function ensureTimerBadge(){
  if(!document.getElementById('timer')){
    const badge=document.createElement('span');
    badge.id='timer'; badge.className='timer'; badge.textContent='60:00';
    const header=document.querySelector('.appbar');
    const meta=document.querySelector('.appbar .meta');
    if(header) header.insertBefore(badge, meta || null);
  }
})();

/* ===== Global 60-minute reading countdown (persists across passages) ===== */
(function readingCountdown(){
  const DURATION_MS = 60 * 60 * 1000;
  const END_KEY = 'sp_reading_end_ts';
  const DONE_KEY = 'sp_reading_done';
  const timerEl = document.getElementById('timer');

  let end = parseInt(localStorage.getItem(END_KEY)||'0', 10);
  const now = Date.now();
  if (!end || end < now) {
    end = now + DURATION_MS;
    localStorage.setItem(END_KEY, String(end));
    localStorage.removeItem(DONE_KEY);
  }
  function fmt(n){ return String(n).padStart(2,'0'); }

  function disableInputs(){
    document.querySelectorAll('input, select, textarea, button').forEach(el=>{
      if (el.id !== 'themeToggle') el.disabled = true;
    });
  }

  function timeUp(){
    if (localStorage.getItem(DONE_KEY)==='1'){ window.location.href='writing.html'; return; }
    disableInputs();
    aggregateAllAnswers();
    localStorage.setItem('sp_reading_submitted_at', new Date().toISOString());
    localStorage.setItem(DONE_KEY,'1');
    setTimeout(()=>window.location.href='writing.html', 300);
  }

  (function tick(){
    if (localStorage.getItem(DONE_KEY)==='1'){ window.location.href='writing.html'; return; }
    const remain = parseInt(localStorage.getItem(END_KEY)||String(end),10) - Date.now();
    if (remain <= 0){ if (timerEl) timerEl.textContent='00:00'; timeUp(); return; }
    const s = Math.floor(remain/1000), m=Math.floor(s/60), r=s%60;
    if (timerEl) timerEl.textContent = `${fmt(m)}:${fmt(r)}`;
    setTimeout(tick, 250);
  })();

  // Save on any click to writing page
  document.addEventListener('click', (ev)=>{
    const a = ev.target.closest('a[href$="writing.html"]');
    if(!a) return;
    aggregateAllAnswers();
    localStorage.setItem('sp_reading_submitted_at', new Date().toISOString());
    localStorage.setItem(DONE_KEY,'1');
  });

  // Expose helper if needed elsewhere
  window.sp_saveReadingAndGo = function(){
    aggregateAllAnswers();
    localStorage.setItem('sp_reading_submitted_at', new Date().toISOString());
    localStorage.setItem(DONE_KEY,'1');
    window.location.href='writing.html';
  };
})();

// Background autosave hooks
window.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='hidden') aggregateAllAnswers(); });
window.addEventListener('pagehide', aggregateAllAnswers);
window.addEventListener('beforeunload', aggregateAllAnswers);

// First aggregate right away so you can see saved objects in DevTools
aggregateAllAnswers();
</script>

</body>
</html>
