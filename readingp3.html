<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sevenplus â€” Reading (Passage 3)</title>
<link rel="icon" href="./favicon/favicon-180.png" sizes="32x32">
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<meta name="theme-color" content="#1aa2c9">
<style>
  :root{--brand-blue:#1aa2c9;--brand-gray:#55595c;--bg:#f7f9fb;--panel:#fff;--text:#1b1f23;--line:#e5e8eb}
  [data-theme="dark"]{--bg:#0e1116;--panel:#141922;--text:#e6edf3;--line:#2a2f38}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto}
  .appbar{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;padding:10px 16px;z-index:10}
  .logo-text{font-size:1.2rem;text-decoration:none}
  .meta{margin-left:auto;display:flex;gap:10px;align-items:center}
  .btn{border:1px solid var(--line);background:var(--panel);padding:.55rem .9rem;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--brand-blue);color:#fff;border-color:var(--brand-blue)}
  .btn.ghost{background:transparent}
  .btn.active{background:var(--brand-blue);color:#fff;border-color:var(--brand-blue);pointer-events:none}
  main{max-width:1200px;margin:16px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .toolbar{display:flex;gap:8px;align-items:center;border:1px dashed var(--line);padding:8px;border-radius:10px;margin:10px 0}
  .swatch{width:20px;height:20px;border-radius:4px;border:1px solid var(--line);cursor:pointer}
  .swatch.yellow{background:#fff59d}
  .swatch.green{background:#c8e6c9}
  .swatch.eraser{display:flex;align-items:center;justify-content:center;font-size:14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .panel{min-height:60vh;max-height:calc(100vh - 150px);overflow:auto;border:1px solid var(--line);border-radius:12px;padding:16px;background:var(--panel)}
  h1,h2,h3{margin:.2rem 0}
  .note{color:#667085}
  .qblock{border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
  .options{display:grid;gap:6px;margin-top:8px}
  input[type=text]{width:100%;padding:.5rem .6rem;border:1px solid var(--line);border-radius:10px}
  footer.nav{display:flex;gap:8px;justify-content:center;margin:14px 0}
  footer.nav a{text-decoration:none}
  .timer{margin-left:8px;padding:.25rem .55rem;border:1px solid var(--line);border-radius:10px;background:var(--panel);font-weight:600;color:var(--brand-blue);min-width:64px;text-align:center}

  /* Highlights */
  .hl{display:inline;padding:0;border:0;line-height:inherit;font:inherit}
  .hl-yellow{background-color:#fff59d}
  .hl-green{background-color:#c8e6c9}

  /* Question number boxes */
  .qnav{display:flex;gap:6px;flex-wrap:wrap;margin:12px 0}
  .qnav button{width:34px;height:34px;border:1px solid var(--line);border-radius:6px;background:#fff;cursor:pointer}
  .qnav button.done{background:#1fb66a;color:#fff;font-weight:600;border-color:#1fb66a}
  .qnav button.active{outline:2px solid var(--brand-blue)}
  @keyframes pulseGreen{0%{box-shadow:0 0 0 0 rgba(31,182,106,.6)}70%{box-shadow:0 0 0 10px rgba(31,182,106,0)}100%{box-shadow:none}}
  .qnav button.pulse{animation:pulseGreen .6s ease-out 1;border-color:#1fb66a}
  [data-theme="dark"] .qnav button{background:var(--panel)}

  /* Drag & drop chips (for 27â€“31) */
  .bank{display:flex;flex-wrap:wrap;gap:8px;padding:8px;border:1px dashed var(--line);border-radius:10px;margin:6px 0;background:var(--panel)}
  .chip{user-select:none;cursor:grab;display:inline-flex;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}
  [data-theme="dark"] .chip{background:var(--panel)}
  .drop{display:inline-flex;min-width:160px;min-height:34px;align-items:center;justify-content:center;padding:4px 8px;border:2px dashed var(--line);border-radius:8px;margin:0 4px}
  .drop.filled{border-style:solid}
  .drop.dd-correct{border-color:#1fb66a;animation:pulseGreen .6s ease-out 1}
</style>
</head>
<body>
<header class="appbar">
  <span class="logo-text"><strong style="color:var(--brand-blue)">seven</strong><strong style="color:var(--brand-gray)">plus</strong></span>
  <span id="timer" class="timer" aria-live="polite">60:00</span>
  <div class="meta">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input id="themeToggle" type="checkbox" />
      <span>ðŸŒ“</span>
    </label>
  </div>
</header>

<main>
  <div class="card">
    <div class="toolbar"><span>Highlighter:</span>
      <button class="swatch yellow" data-hl="yellow" title="Yellow"></button>
      <button class="swatch green" data-hl="green" title="Green"></button>
      <button class="swatch eraser" id="hl-eraser" title="Eraser">ðŸ§½</button>
    </div>

    <div class="grid">
      <!-- LEFT: PASSAGE -->
      <article id="passage" class="panel" tabindex="0">
        <h2>READING PASSAGE 3</h2>
        <p class="note">You should spend about 20 minutes on Questions 27â€“40 which are based on Reading Passage 3.</p>

        <h2 style="text-align:center">Beyond the Blue Line</h2>

        <!-- Paste of the passage user provided -->
        <p><strong>A</strong>  Much of the thrill of venturing to the far side of the world rests on the romance of difference. So one feels a certain sympathy for Captain James Cook on the day in 1778 that he "discovered" Hawaii. Then on his third expedition to the Pacific, the British navigator had explored scores of islands across the breadth of the sea, from lush New Zealand to the lonely wastes of Easter Island. This latest voyage had taken him thousands of miles north from the Society Islands to an archipelago so remote that even the old Polynesians back on Tahiti knew nothing about it. Imagine Cook's surprise, then, when the natives of Hawaii came paddling out in their canoes and greeted him in a familiar tongue, one he had heard on virtually every mote of inhabited land he had visited. Marveling at the ubiquity of this Pacific language and culture, he later wondered in his journal: "How shall we account for this Nation spreading itself so far over this vast ocean?"</p>
        <p><strong>B</strong> That question, and others that flow from it has tantalized inquiring minds for centuries: Who were these amazing seafarers? Where did they come from, starting more than 3,000 years ago? And how could a Neolithic people with simple canoes and no navigation gear manage to find, let alone colonize, hundreds of far-flung island specks scattered across an ocean that spans nearly a third of the globe? Answers have been slow in coming. But now a startling archaeological find on the island of Ã‰fatÃ©, in the Pacific nation of Vanuatu, has revealed an ancient seafaring people, the distant ancestors of today's Polynesians, taking their first steps into the unknown. The discoveries there have also opened a window into the shadowy world of those early voyagers.</p>
        <p><strong>C</strong> "What we have is a first- or second-generation site containing the graves of some of the Pacific's first explorers," says Spriggs, professor of archaeology at the Australian National University and co-leader of an international team excavating the site. It came to light only by luck. A backhoe operator, digging up topsoil on the grounds of a derelict coconut plantation, scraped open a grave â€“ the first of dozens in a burial ground some 3,000 years old. It is the oldest cemetery ever found in the Pacific islands, and it harbors the bones of an ancient people archaeologists call the Lapita, a label that derives from a beach in New Caledonia where a landmark cache of their pottery was found in the 1950s.</p>
        <p><strong>D</strong>They were daring blue-water adventurers who roved the sea not just as explorers but also as pioneers, bringing along everything they would need to build new lives â€“ their families and livestock, taro seedlings and stone tools. Within the span of a few centuries, the Lapita stretched the boundaries of their world from the jungle-clad volcanoes of Papua New Guinea to the loneliest coral outliers of Tonga, at least 2,000 miles eastward in the Pacific. Along the way they explored millions of square miles of an unknown sea, discovering and colonizing scores of tropical islands never before seen by human eyes: Vanuatu, New Caledonia, Fiji, Samoa.

          It was their descendants, centuries later, who became the great Polynesian navigators we all tend to think of: the Tahitians and Hawaiians, the New Zealand Maori, and the curious people who erected those statues on Easter Island. But it was the Lapita who laid the foundation â€“ who bequeathed to the island the language, customs, and cultures that their more famous descendants carried around the Pacific.</p>
        <p><strong>E</strong> While the Lapita left a glorious legacy, they also left precious few clues about themselves. A particularly intriguing clue comes from chemical tests on the teeth of several skeletons. Then as now, the food and water you consume as a child deposits oxygen, carbon, strontium, and other elements in your still-forming adult teeth. The isotope signatures of these elements vary subtly from place to place, so that if you grow up in, say, Buffalo, New York, then spend your adult life in California, tests on the isotopes in your teeth will always reveal your eastern roots.

          Isotope analysis indicates that several of the Lapita buried on Ã‰fatÃ© didn't spend their childhoods here but came from somewhere else. And while isotopes can't pinpoint their precise island of origin, this much is clear: At some point in their lives, these people left the villages of their birth and made a voyage by seagoing canoe, never to return. DNA teased from these ancient bones may also help answer one of the most puzzling questions in Pacific anthropology: Did all Pacific islanders spring from one source or many? Was there only one outward migration from a single point in Asia, or several from different points? "This represents the best opportunity we've had yet," says Spriggs, "to find out who the Lapita actually were, where they came from, and who their closest descendants are today."</p>
        <p><strong>F</strong>There is one stubborn question for which archaeology has yet to provide any answers: How did the Lapita accomplish the ancient equivalent of a moon landing, many times over? No one has found one of their canoes or any rigging, which could reveal how the canoes were sailed. Nor do the oral histories and traditions of later Polynesians offer any insights.

          "All we can say for certain is that the Lapita had canoes that were capable of ocean voyages, and they had the ability to sail them," says Geoff Irwin, a professor of archaeology at the University of Auckland and an avid yachtsman. Those sailing skills, he says, were developed and passed down over thousands of years by earlier mariners who worked their way through the archipelagoes of the western Pacific making short crossings to islands within sight of each other. The real adventure didn't begin, however, until their Lapita descendants neared the end of the Solomons chain, for this was the edge of the world. The nearest landfall, the Santa Cruz Islands, is almost 230 miles away, and for at least 150 of those miles, the Lapita sailors would have been out of sight of land, with empty horizons on every side.</p>
        <p><strong>G</strong> The Lapita's thrust into the Pacific was eastward, against the prevailing trade winds, Irwin notes. Those nagging headwinds, he argues, may have been the key to their success. "They could sail out for days into the unknown and reconnoiter, secure in the knowledge that if they didn't find anything, they could turn about and catch a swift ride home on the trade winds. It's what made the whole thing work." Once out there, skilled seafarers would detect abundant leads to follow to land: seabirds and turtles, coconuts and twigs carried out to sea by the tides and the afternoon pileup of clouds on the horizon that often betokens an island in the distance.

          All this presupposes one essential detail, says Atholl Anderson, professor of prehistory at the Australian National University and, like Irwin, a keen yachtsman: that the Lapita had mastered the advanced art of tacking into the wind. "And there's no proof that they could do any such thing," Anderson says. "There has been this assumption that they must have done so, and people have built canoes to re-create those early voyages based on that assumption. But nobody has any idea what their canoes looked like or how they were rigged."</p>
        <p><strong>H</strong> However they did it, the Lapita spread themselves a third of the way across the Pacific, then called it quits for reasons known only to them. Ahead lay the vast emptiness of the central Pacific, and perhaps they were too thinly stretched to venture farther. They probably never numbered more than a few thousand in total, and in their rapid migration eastward they encountered hundreds of islands â€“ more than 300 in Fiji alone. Supplied with such an embarrassment of riches, they could settle down and enjoy what for a time was Earth's last Edens.</p>
        <p><strong>I</strong> Rather than give all the credit to human skill and daring, Anderson invokes the winds of change. El NiÃ±o, the same climate disruption that affects the Pacific today, may have helped scatter the first settlers to the ends of the ocean, Anderson suggests. Climate data obtained from slow-growing corals around the Pacific and from lake-bed sediments in the Andes of South America point to a series of unusually frequent El NiÃ±o around the time of the Lapita expansion, and again between 1,600 and 1,200 years ago, when the second wave of pioneer navigators made their voyages farther east, to the remotest corners of the Pacific. By reversing the regular east-to-west flow of the trade winds for weeks at a time, these "super El NiÃ±o" might have sped the Pacific's ancient mariners on long, unplanned voyages could have been key to launching Polynesians across the wide expanse of open water between Tonga, where the Lapita stopped, and the distant archipelagoes of eastern Polynesia. "Once they crossed that gap, they could island-hop throughout the region, and from the Marquesas, it's mostly downwind to Hawaii," Anderson says. It took another 400 years for mariners to reach Easter Island, which lies in the opposite direction â€“ normally upwind. "Once again this was during a period of frequent El NiÃ±o activity."</p>

        <!-- number nav -->
        <div class="qnav" id="qnav">
          <button data-q="q27">27</button><button data-q="q28">28</button><button data-q="q29">29</button><button data-q="q30">30</button><button data-q="q31">31</button><button data-q="q32">32</button><button data-q="q33">33</button><button data-q="q34">34</button><button data-q="q35">35</button><button data-q="q36">36</button><button data-q="q37">37</button><button data-q="q38">38</button><button data-q="q39">39</button><button data-q="q40">40</button>
        </div>
      </article>

      <!-- RIGHT: QUESTIONS -->
      <aside id="questions" class="panel" tabindex="0">
        <h3>Questions 27â€“31</h3>
        <p>Complete the summary using the list of words Aâ€“L. <em>(Drag a chip into each blank.)</em></p>

        <div class="qblock">
          <div class="bank" id="bank">
            <span class="chip" draggable="true" data-key="A">A. bones</span>
            <span class="chip" draggable="true" data-key="B">B. co-leader</span>
            <span class="chip" draggable="true" data-key="C">C. descendents</span>
            <span class="chip" draggable="true" data-key="D">D. international team</span>
            <span class="chip" draggable="true" data-key="E">E. inquiring minds</span>
            <span class="chip" draggable="true" data-key="F">F. proof</span>
            <span class="chip" draggable="true" data-key="G">G. ancestors</span>
            <span class="chip" draggable="true" data-key="H">H. early seafarers</span>
            <span class="chip" draggable="true" data-key="I">I. pottery</span>
            <span class="chip" draggable="true" data-key="J">J. assumption</span>
            <span class="chip" draggable="true" data-key="K">K. horizons</span>
            <span class="chip" draggable="true" data-key="L">L. grave</span>
          </div>

          <div id="q27" class="qblock" style="border:0;padding:0;margin:0">
            <p>
              The question, arisen from Captain Cookâ€™s expedition to Hawaii, and others derived from it, has fascinated researchers for a long time. However, a surprising archaeological find on Ã‰fatÃ© began to provide valuable information about the
              <span class="drop" id="drop27" data-answer="G" data-label="27">27</span>
              of Lapita. On the excavating site, a
              <span class="drop" id="drop28" data-answer="L" data-label="28">28</span>
              containing
              <span class="drop" id="drop29" data-answer="A" data-label="29">29</span>
              of Lapita was uncovered. Later on, various researches and tests have been done to study the ancient people â€“ Lapita and their
              <span class="drop" id="drop30" data-answer="C" data-label="30">30</span>.
              How could they manage to spread themselves so far over the vast ocean? All that is certain is that they were good at canoeing. And perhaps they could take well advantage of the trade wind. But there is no
              <span class="drop" id="drop31" data-answer="F" data-label="31">31</span>
              of it.
            </p>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
              <button class="btn" id="reset27to31">Reset</button>
            </div>
          </div>
        </div>

        <h3 style="margin-top:16px">Questions 32â€“35</h3>
        <p>Choose the correct answer.</p>

        <div class="qblock" id="q32">
          <p><strong>32.</strong> The chemical tests indicate that</p>
          <div class="options">
            <label><input type="radio" name="P3_Q32" value="A"> the elements in one's teeth varied from childhood to adulthood.</label>
            <label><input type="radio" name="P3_Q32" value="B"> the isotope signatures of the elements remain the same in different places.</label>
            <label><input type="radio" name="P3_Q32" value="C"> the result of the study is not fascinating.</label>
            <label><input type="radio" name="P3_Q32" value="D"> these chemicals can't conceal one's origin.</label>
          </div>
        </div>

        <div class="qblock" id="q33">
          <p><strong>33.</strong> The isotope analysis from the Lapita</p>
          <div class="options">
            <label><input type="radio" name="P3_Q33" value="A"> exactly locates their birth island.</label>
            <label><input type="radio" name="P3_Q33" value="B"> reveals that the Lapita found the new place via straits.</label>
            <label><input type="radio" name="P3_Q33" value="C"> helps researchers to find out answers about the islanders.</label>
            <label><input type="radio" name="P3_Q33" value="D"> leaves more new questions for anthropologists to answer.</label>
          </div>
        </div>

        <div class="qblock" id="q34">
          <p><strong>34.</strong> According to paragraph F, the offspring of Lapita</p>
          <div class="options">
            <label><input type="radio" name="P3_Q34" value="A"> were capable of voyages to land that is not accessible to view.</label>
            <label><input type="radio" name="P3_Q34" value="B"> were able to have the farthest voyage of 230 miles.</label>
            <label><input type="radio" name="P3_Q34" value="C"> worked their way through the archipelagoes of the western Pacific.</label>
            <label><input type="radio" name="P3_Q34" value="D"> fully explored the horizons.</label>
          </div>
        </div>

        <div class="qblock" id="q35">
          <p><strong>35.</strong> Once out exploring the sea, the sailors</p>
          <div class="options">
            <label><input type="radio" name="P3_Q35" value="A"> always found the trade winds unsuitable for sailing.</label>
            <label><input type="radio" name="P3_Q35" value="B"> could return home with various clues.</label>
            <label><input type="radio" name="P3_Q35" value="C"> sometimes would overshoot their home port and sail off into eternity.</label>
            <label><input type="radio" name="P3_Q35" value="D"> would sail in one direction.</label>
          </div>
        </div>

        <h3 style="margin-top:16px">Questions 36â€“40</h3>
        <p>TRUE if the statement is true â€” FALSE if it is false â€” NOT GIVEN if the information is not in the passage.</p>

        <div class="qblock" id="q36">
          <p><strong>36.</strong> The Lapita could canoe in the prevailing wind.</p>
          <div class="options">
            <label><input type="radio" name="P3_Q36" value="TRUE"> TRUE</label>
            <label><input type="radio" name="P3_Q36" value="FALSE"> FALSE</label>
            <label><input type="radio" name="P3_Q36" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <div class="qblock" id="q37">
          <p><strong>37.</strong> It was difficult for the sailors to find ways back, once they were out.</p>
          <div class="options">
            <label><input type="radio" name="P3_Q37" value="TRUE"> TRUE</label>
            <label><input type="radio" name="P3_Q37" value="FALSE"> FALSE</label>
            <label><input type="radio" name="P3_Q37" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <div class="qblock" id="q38">
          <p><strong>38.</strong> The reason why the Lapita stopped canoeing farther is still unknown.</p>
          <div class="options">
            <label><input type="radio" name="P3_Q38" value="TRUE"> TRUE</label>
            <label><input type="radio" name="P3_Q38" value="FALSE"> FALSE</label>
            <label><input type="radio" name="P3_Q38" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <div class="qblock" id="q39">
          <p><strong>39.</strong> The majority of the Lapita dwelled on Fiji.</p>
          <div class="options">
            <label><input type="radio" name="P3_Q39" value="TRUE"> TRUE</label>
            <label><input type="radio" name="P3_Q39" value="FALSE"> FALSE</label>
            <label><input type="radio" name="P3_Q39" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <div class="qblock" id="q40">
          <p><strong>40.</strong> The navigators could take advantage of El NiÃ±o during their forth voyages.</p>
          <div class="options">
            <label><input type="radio" name="P3_Q40" value="TRUE"> TRUE</label>
            <label><input type="radio" name="P3_Q40" value="FALSE"> FALSE</label>
            <label><input type="radio" name="P3_Q40" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <footer class="nav">
          <a class="btn ghost" href="readingp1.html">Passage 1</a>
          <a class="btn ghost" href="readingp2.html">Passage 2</a>
          <a class="btn active" href="readingp3.html" aria-current="page">Passage 3</a>
        </footer>
        <button class="btn primary" id="proceedBtn">Proceed to Writing</button>
      </aside>
    </div>
  </div>
</main>

<script>
/* ===== Theme ===== */
(function(){
  const t=document.getElementById('themeToggle');
  if(!t) return;
  const saved=localStorage.getItem('sp_theme')||'light';
  document.documentElement.setAttribute('data-theme', saved);
  t.checked=(saved==='dark');
  t.addEventListener('change',()=>{ const m=t.checked?'dark':'light'; document.documentElement.setAttribute('data-theme',m); localStorage.setItem('sp_theme',m); });
})();

/* ===== Highlighter ===== */
(function(){
  function wrap(color){
    const sel=window.getSelection(); if(!sel||sel.isCollapsed) return;
    const r=sel.getRangeAt(0); const span=document.createElement('span');
    span.className='hl '+(color==='yellow'?'hl-yellow':'hl-green');
    try{ r.surroundContents(span);}catch{}
    sel.removeAllRanges();
  }
  function erase(){
    const sel=window.getSelection(); if(!sel||sel.isCollapsed) return;
    const r=sel.getRangeAt(0);
    document.querySelectorAll('#passage span.hl').forEach(el=>{
      try{
        if(r.intersectsNode(el)){ const p=el.parentNode; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); p.normalize(); }
      }catch{}
    });
    sel.removeAllRanges();
  }
  document.querySelectorAll('[data-hl]').forEach(b=>b.addEventListener('click',()=>wrap(b.dataset.hl)));
  document.getElementById('hl-eraser')?.addEventListener('click', erase);
})();

/* ===== Nav jump ===== */
(function(){
  const qnav=document.getElementById('qnav');
  const pane=document.getElementById('questions');
  if(!qnav||!pane) return;
  qnav.addEventListener('click',e=>{
    const btn=e.target.closest('button[data-q]'); if(!btn) return;
    const target=document.getElementById(btn.dataset.q);
    if(target){ pane.scrollTo({top: target.offsetTop-8, behavior:'smooth'}); }
    qnav.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
})();
function pulseBox(qid){
  const btn=document.querySelector(`.qnav button[data-q="${qid}"]`);
  if(btn){ btn.classList.add('pulse'); setTimeout(()=>btn.classList.remove('pulse'),650); }
}

/* ===== Save all answers snapshot ===== */
(function(){
  function collect(){
    const a={};
    document.querySelectorAll('input[type=radio]:checked').forEach(el=>a[el.name]=el.value);
    ['drop27','drop28','drop29','drop30','drop31'].forEach(id=>{ const chip=document.querySelector('#'+id+' .chip'); a[id]=chip?chip.dataset.key:''; });
    a.__page='reading_p3';
    localStorage.setItem('sp_reading_answers', JSON.stringify(a));
    localStorage.setItem('sp_reading_saved_at', new Date().toISOString());
    const bundle={page:'reading_p3', savedAt:new Date().toISOString(), answers:a};
    localStorage.setItem('sp_reading_p3', JSON.stringify(bundle));
  }
  window.__sp_collectReadingAnswers = collect;
  const snap=()=>{ try{ collect(); }catch{} };
  window.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='hidden') snap(); });
  window.addEventListener('pagehide', snap);
  window.addEventListener('beforeunload', snap);
  document.addEventListener('change', snap, true);
})();

/* ===== Persist radios (group keys P3_*) ===== */
(function(){
  const keyFor = (raw)=> raw.startsWith('P3_')?raw:('P3_'+raw);
  document.querySelectorAll('input[type=radio]').forEach(el=>{
    const k=keyFor(el.name||el.id||'radio');
    const saved=localStorage.getItem(k);
    if(saved===el.value) el.checked=true;
    el.addEventListener('change',()=>{ if(el.checked){ localStorage.setItem(k, el.value); window.__sp_collectReadingAnswers&&__sp_collectReadingAnswers(); } });
  });
})();

/* ===== Mark green when answered (32â€“40 radios, 27â€“31 drops handled below) ===== */
(function(){
  const map={
    q32:'input[name="P3_Q32"]', q33:'input[name="P3_Q33"]', q34:'input[name="P3_Q34"]', q35:'input[name="P3_Q35"]',
    q36:'input[name="P3_Q36"]', q37:'input[name="P3_Q37"]', q38:'input[name="P3_Q38"]', q39:'input[name="P3_Q39"]', q40:'input[name="P3_Q40"]'
  };
  const qnav=document.getElementById('qnav'); if(!qnav) return;
  const btnFor=id=>qnav.querySelector(`button[data-q="${id}"]`);
  function update(id){
    const btn=btnFor(id); if(!btn) return;
    const sel=map[id]; const done=!!document.querySelector(sel+':checked');
    btn.classList.toggle('done', done);
  }
  Object.entries(map).forEach(([qid, sel])=>{
    document.querySelectorAll(sel).forEach(r=>r.addEventListener('change',()=>{ update(qid); pulseBox(qid); window.__sp_collectReadingAnswers&&__sp_collectReadingAnswers(); }));
  });
  setTimeout(()=>Object.keys(map).forEach(update),0);
})();

/* ===== Drag & Drop for 27â€“31 ===== */
(function(){
  const bank=document.getElementById('bank');
  const drops=[27,28,29,30,31].map(n=>document.getElementById('drop'+n));
  const LS='P3_DD_';

  function chipByKey(key){
    return bank.querySelector(`.chip[data-key="${key}"]`) || document.querySelector(`.chip[data-key="${key}"]`);
  }
  function wire(chip){
    chip.addEventListener('dragstart',e=>{ e.dataTransfer.setData('text/plain', chip.dataset.key); e.dataTransfer.effectAllowed='move'; chip.classList.add('dragging'); });
    chip.addEventListener('dragend',()=>chip.classList.remove('dragging'));
  }
  bank.querySelectorAll('.chip').forEach(wire);

  function markDone(qid,on){ const b=document.querySelector(`.qnav button[data-q="${qid}"]`); if(b) b.classList.toggle('done', !!on); }

  function fill(dz,key){
    const existing=dz.querySelector('.chip'); if(existing) bank.appendChild(existing);
    const chip=chipByKey(key); if(!chip) return;
    dz.textContent=''; dz.appendChild(chip); dz.classList.add('filled');
    const ok=(dz.dataset.answer===key); dz.classList.toggle('dd-correct', ok);
    if(ok) pulseBox(dz.id.replace('drop','q'));
    localStorage.setItem(LS+dz.id, key);
    markDone(dz.id.replace('drop','q'), true);
    window.__sp_collectReadingAnswers&&__sp_collectReadingAnswers();
  }
  function clear(dz){
    const c=dz.querySelector('.chip'); if(c) bank.appendChild(c);
    dz.classList.remove('filled','dd-correct'); dz.textContent=dz.dataset.label;
    localStorage.removeItem(LS+dz.id);
    markDone(dz.id.replace('drop','q'), false);
    window.__sp_collectReadingAnswers&&__sp_collectReadingAnswers();
  }

  drops.forEach(dz=>{
    dz.addEventListener('dragover',e=>e.preventDefault());
    dz.addEventListener('drop',e=>{ e.preventDefault(); const key=e.dataTransfer.getData('text/plain'); if(key) fill(dz,key); });
    dz.addEventListener('dblclick',()=>clear(dz));
  });

  // restore
  drops.forEach(dz=>{
    const saved=localStorage.getItem(LS+dz.id);
    if(saved) fill(dz, saved); else dz.textContent=dz.dataset.label;
  });

  document.getElementById('reset27to31').addEventListener('click',()=>drops.forEach(clear));
})();

/* ===== Footer nav & timer ===== */
(function(){
  document.querySelectorAll('footer.nav a').forEach(a=>{
    a.addEventListener('click',e=>{ e.preventDefault(); window.__sp_collectReadingAnswers&&__sp_collectReadingAnswers(); window.location.href=a.getAttribute('href'); });
  });
})();

(function(){
  if(!document.getElementById('timer')){
    const b=document.createElement('span'); b.id='timer'; b.className='timer'; b.textContent='60:00';
    const header=document.querySelector('.appbar'), meta=document.querySelector('.appbar .meta');
    if(header) header.insertBefore(b, meta||null);
  }
  const D=60*60*1000, END='sp_reading_end_ts', DONE='sp_reading_done', t=document.getElementById('timer');
  let end=parseInt(localStorage.getItem(END)||'0',10); const now=Date.now();
  if(!end||end<now){ end=now+D; localStorage.setItem(END,String(end)); localStorage.removeItem(DONE); }
  const fmt=n=>String(n).padStart(2,'0');
  function redirect(){ window.location.href='writing.html'; }
  function finalize(){ try{ document.querySelectorAll('input,select,textarea,button').forEach(el=>{ if(el.id!=='themeToggle') el.disabled=true; }); }catch{} window.__sp_collectReadingAnswers&&__sp_collectReadingAnswers(); localStorage.setItem('sp_reading_submitted_at', new Date().toISOString()); localStorage.setItem(DONE,'1'); setTimeout(redirect,300); }
  (function tick(){
    if(localStorage.getItem(DONE)==='1'){ redirect(); return; }
    const rem=(parseInt(localStorage.getItem(END)||String(end),10))-Date.now();
    if(rem<=0){ if(t) t.textContent='00:00'; finalize(); return; }
    const s=Math.floor(rem/1000), m=Math.floor(s/60), r=s%60; if(t) t.textContent=`${fmt(m)}:${fmt(r)}`;
    setTimeout(tick,250);
  })();
})();

/* ===== Proceed ===== */
document.getElementById('proceedBtn').addEventListener('click',()=>{
  window.__sp_collectReadingAnswers&&__sp_collectReadingAnswers();
  localStorage.setItem('sp_reading_done','1');
  localStorage.setItem('sp_reading_submitted_at', new Date().toISOString());
  window.location.href='writing.html';
});
</script>
</body>
</html>
