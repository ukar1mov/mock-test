<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sevenplus â€” Reading (Passage 3)</title>
<link rel="icon" href="./icons/favicon-180.png" type="image/svg+xml">
<link rel="icon" href="./icons/favicon-180.png" sizes="32x32">
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<meta name="theme-color" content="#1aa2c9">
<style>
  :root{--brand-blue:#1aa2c9;--brand-gray:#55595c;--bg:#f7f9fb;--panel:#fff;--text:#1b1f23;--line:#e5e8eb}
  [data-theme="dark"]{--bg:#0e1116;--panel:#141922;--text:#e6edf3;--line:#2a2f38}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto}
  .appbar{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;padding:10px 16px;z-index:10}
  .logo-text{font-size:1.2rem;text-decoration:none}
  .meta{margin-left:auto;display:flex;gap:10px;align-items:center}
  .btn{border:1px solid var(--line);background:var(--panel);padding:.55rem .9rem;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--brand-blue);color:#fff;border-color:var(--brand-blue)}
  .btn.ghost{background:transparent}
  .btn.active{background:var(--brand-blue);color:#fff;border-color:var(--brand-blue);pointer-events:none}
  main{max-width:1200px;margin:16px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .toolbar{display:flex;gap:8px;align-items:center;border:1px dashed var(--line);padding:8px;border-radius:10px;margin:10px 0}
  .swatch{width:20px;height:20px;border-radius:4px;border:1px solid var(--line);cursor:pointer}
  .swatch.yellow{background:#fff59d}
  .swatch.green{background:#c8e6c9}
  .swatch.eraser{display:flex;align-items:center;justify-content:center;font-size:14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .panel{min-height:60vh;max-height:calc(100vh - 150px);overflow:auto;border:1px solid var(--line);border-radius:12px;padding:16px;background:var(--panel)}
  h1,h2,h3{margin:.2rem 0}
  .note{color:#667085}
  .qblock{border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 0}
  /* Keep class for compatibility; no card flash */
  .qblock.correct{border-color:inherit;animation:none}
  .options{display:grid;gap:6px;margin-top:8px}
  input[type=text]{width:100%;padding:.5rem .6rem;border:1px solid var(--line);border-radius:10px}
  footer.nav{display:flex;gap:8px;justify-content:center;margin:14px 0}
  footer.nav a{ text-decoration:none }
  .timer{margin-left:8px;padding:.25rem .55rem;border:1px solid var(--line);border-radius:10px;background:var(--panel);font-weight:600;color:var(--brand-blue);min-width:64px;text-align:center}

  /* Highlights should not shift layout */
  .hl{display:inline;padding:0;border:0;line-height:inherit;font:inherit}
  .hl-yellow{background-color:#fff59d}
  .hl-green{background-color:#c8e6c9}

  /* Question number boxes */
  .qnav{display:flex;gap:6px;flex-wrap:wrap;margin:12px 0}
  .qnav button{width:34px;height:34px;border:1px solid var(--line);border-radius:6px;background:#fff;cursor:pointer}
  .qnav button.done{background:#1fb66a;color:#fff;font-weight:600;border-color:#1fb66a}
  .qnav button.active{outline:2px solid var(--brand-blue)}
  @keyframes pulseGreen{0%{box-shadow:0 0 0 0 rgba(31,182,106,.6)}70%{box-shadow:0 0 0 10px rgba(31,182,106,0)}100%{box-shadow:none}}
  /* Only the numbered boxes (below the text) should flash */
  .qnav button.pulse{animation:pulseGreen .6s ease-out 1;border-color:#1fb66a}
  [data-theme="dark"] .qnav button{background:var(--panel)}

  /* Drag & drop (Q36â€“40) */
  .bank{display:flex;flex-wrap:wrap;gap:8px;padding:8px;border:1px dashed var(--line);border-radius:10px;margin:6px 0;background:var(--panel)}
  .chip{user-select:none;cursor:grab;display:inline-flex;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}
  [data-theme="dark"] .chip{background:var(--panel)}
  .drop{display:inline-flex;min-width:160px;min-height:34px;align-items:center;justify-content:center;padding:4px 8px;border:2px dashed var(--line);border-radius:8px;margin:0 4px}
  .drop.filled{border-style:solid}
  .drop.dd-correct{border-color:#1fb66a;animation:pulseGreen .6s ease-out 1}
</style>
</head>
<body>
<header class="appbar">
  <span class="logo-text"><strong style="color:var(--brand-blue)">seven</strong><strong style="color:var(--brand-gray)">plus</strong></span>
  <span id="timer" class="timer" aria-live="polite">60:00</span>
  <div class="meta">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input id="themeToggle" type="checkbox" />
      <span>ðŸŒ“</span>
    </label>
  </div>
</header>

<main>
  <div class="card">
    <div class="toolbar"><span>Highlighter:</span>
      <button class="swatch yellow" data-hl="yellow" title="Yellow"></button>
      <button class="swatch green" data-hl="green" title="Green"></button>
      <button class="swatch eraser" id="hl-eraser" title="Eraser">ðŸ§½</button>
    </div>

    <div class="grid">
      <!-- LEFT: PASSAGE (scrollable) -->
      <article id="passage" class="panel" tabindex="0">
        <h2>READING PASSAGE 3</h2>
        <p class="note">You should spend about 20 minutes on Questions 27â€“40 which are based on Reading Passage 3.</p>

        <h2 style="text-align:center">Environmentally-friendly vehicles</h2>

        <p><strong>A</strong> In the early 1990s, the California Air Resources Board (CARB), the government of California's "clean air agency", began a push for more fuel-efficient, lower-emissions vehicles, with the ultimate goal being a move to zero-emissions vehicles such as electric vehicles. In response, automakers developed electric models, including the Chrysler TEVan, Ford Ranger EV pickup truck, GM EV1 and S10 EV pickup, Honda EV Plus hatchback, Nissan lithium-battery Altra EV miniwagon and Toyota RAV4 EV. Ford Fusion is manufactured at Ford's Hermosillo Stamping &amp; Assembly plant, located in Sonora Mexico. I thought going green was supposed to provide the U.S. with more jobs.</p>

        <p><strong>B</strong> The automakers were accused of pandering to the wishes of CARB in order to continue to be allowed to sell cars in the lucrative Californian market, while failing to adequately promote their electric vehicles in order to create the impression that the consumers were not interested in the cars, all the while joining oil industry lobbyists in vigorously protesting CARB's mandate. GM's program came under particular scrutiny; in an unusual move, consumers were not allowed to purchase EV1s, but were instead asked to sign closed-end leases, meaning that the cars had to be returned to GM at the end of the lease period, with no option to purchase, despite lesser interest in continuing to own the cars. Chrysler, Toyota, and a group of GM dealers sued CARB in Federal court, leading to the eventual neutering of CARB's ZEV Mandate.</p>

        <p><strong>C</strong> After public protests by EV drivers' groups upset by the repossession of their cars, Toyota offered the last 328 RAV4-EVs for sale to the general public during six months, up until November 22, 2002. Almost all other production electric cars were withdrawn from the market and were in some cases seen to have been destroyed by their manufactures. Toyota continues to support the several hundred Toyota RAV4-EV in the hands of the general public and in fleet usage. GM famously de-activated the few EV1s that were donated to engineering schools and museums.</p>

        <p><strong>D</strong> Throughout the 1990s, the appeal of fuel-efficient or environmentally friendly cars declined among Americans, who instead favored sport utility vehicles, which were affordable to operate despite their poor fuel efficiency thanks to lower gasoline prices. American automakers chose to focus their product lines around the truck-based vehicles, which enjoyed larger profit margins than the smaller cars which were preferred in places like Europe or Japan. In 1999, the Honda Insight hybrid car became the first hybrid to be sold in North America since the little-known Woods hybrid of 1917.</p>

        <p><strong>E</strong> In 1995, Toyota debuted a hybrid concept car at the Tokyo Motor Show, with testing following a year later. The first Prius, model NHW10, went on sale on December 10, 1997. It was available only in Japan, though it has been imported privately to at least the United Kingdom, Australia, and New Zealand. The first-generation Prius, at its launch, became the world's first mass-produced gasoline-electric hybrid car. The NHW10 Prius styling originated from California designers, who were selected over competing designs from other Toyota design studios.</p>

        <p><strong>F</strong> In the United States, the NHW11 was the first Prius to be sold. The Prius was marketed between the smaller Corolla and the larger Camry. The published retail price of the car was US$19,995. The NHW11 Prius became more powerful partly to satisfy the higher speeds and longer distances that Americans drive. Air conditioning and electric power steering were standard equipment. The vehicle was the second mass-produced hybrid on the American market, after the two-seat Honda Insight. While the larger Prius could seat five, its battery pack restricted cargo space.</p>

        <p><strong>G</strong> Hybrids, which featured a combined gasoline and electric powertrain, were seen as a balance, offering an environmentally friendly image and improved fuel economy, without being hindered by the low range of electric vehicles, albeit at an increased price over comparable gasoline cars. Sales were poor, the lack of interest attributed to the car's small size and the lack of necessity for a fuel-efficient car at the time. The 2000s energy crisis brought renewed interest in hybrid and electric cars. In America, sales of the Toyota Prius jumped, and a variety of automakers followed suit, releasing hybrid models of their own. Several began to produce new electric car prototypes, as consumers called for cars that would free them from the fluctuations of oil prices.</p>

        <p><strong>H</strong> In 2000, Hybrid Technologies, later renamed Li-ion Motors, started manufacturing electric cars in Mooresville, North Carolina. There has been increasing controversy with Li-ion Motors though due to the ongoing 'Lemon issues' regarding their product. And their attempt to cover it up. California electric-car maker Tesla Motors began development in 2004 on the Tesla Roadster, which was first delivered to customers in 2008. The Roadster remained the only highway-capable EV in serial production and available for sale until 2010. Senior leaders at several large automakers, including Nissan and General Motors, have stated that the Roadster was a catalyst which demonstrated that there is pent-up consumer demand for more efficient vehicles. GM Vice Chairman Bob Lutz said in 2007 that the Tesla Roadster inspired him to push GM to develop the Chevrolet Volt, a plug-in hybrid sedan prototype that aims to reverse years of dwindling market share and massive financial losses for America's largest automaker. In an August 2009 edition of The New Yorker, Lutz was quoted as saying, "All the geniuses here at General Motors kept saying lithium-ion technology is 10 years away, and Toyota agreed with us â€“ and boom, along comes Tesla. So I said, 'How come some tiny little California startup, run by guys who know nothing about the car business, can do this, and we can't?' That was the crowbar that helped break up the log jam."
        </p>

        <!-- Numbered navigation boxes 27â€“40 (below the passage text) -->
        <div class="qnav" id="qnav">
          <button data-q="q27">27</button><button data-q="q28">28</button><button data-q="q29">29</button><button data-q="q30">30</button><button data-q="q31">31</button><button data-q="q32">32</button><button data-q="q33">33</button><button data-q="q34">34</button><button data-q="q35">35</button><button data-q="q36">36</button><button data-q="q37">37</button><button data-q="q38">38</button><button data-q="q39">39</button><button data-q="q40">40</button>
        </div>
      </article>

      <!-- RIGHT: QUESTIONS (scrollable) -->
      <aside id="questions" class="panel" tabindex="0">
        <h3>Questions 27â€“30</h3>
        <p>Choose the correct answer.</p>

        <div class="qblock" id="q27" data-type="single" data-answer="A">
          <p><strong>27.</strong> What does the author think of the factory in Sonora in Mexico where the Ford Fusion is manufactured?</p>
          <div class="options">
            <label><input type="radio" name="P3_Q27" value="A"> the factory should be helpful in the US soil business</label>
            <label><input type="radio" name="P3_Q27" value="B"> Employment of US will be created as consumers change their awareness</label>
            <label><input type="radio" name="P3_Q27" value="C"> More competitive cars will be introduced into the market</label>
            <label><input type="radio" name="P3_Q27" value="D"> this issue is hard to give a predict</label>
          </div>
        </div>

        <div class="qblock" id="q28" data-type="single" data-answer="B">
          <p><strong>28.</strong> In the 1990s, what dropped in America for environmentally friendly vehicles?</p>
          <div class="options">
            <label><input type="radio" name="P3_Q28" value="A"> production</label>
            <label><input type="radio" name="P3_Q28" value="B"> Attractiveness</label>
            <label><input type="radio" name="P3_Q28" value="C"> Announcement</label>
            <label><input type="radio" name="P3_Q28" value="D"> Expectation</label>
          </div>
        </div>

        <div class="qblock" id="q29" data-type="single" data-answer="A">
          <p><strong>29.</strong> What did GM notably send to engineering schools and museums?</p>
          <div class="options">
            <label><input type="radio" name="P3_Q29" value="A"> EV 1</label>
            <label><input type="radio" name="P3_Q29" value="B"> CARB</label>
            <label><input type="radio" name="P3_Q29" value="C"> RAV4</label>
            <label><input type="radio" name="P3_Q29" value="D"> MINI E</label>
          </div>
        </div>

        <div class="qblock" id="q30" data-type="single" data-answer="C">
          <p><strong>30.</strong> Nissan and GM high-level leaders declared the real reason for the popularity of Roadster is its</p>
          <div class="options">
            <label><input type="radio" name="P3_Q30" value="A"> legendary concert</label>
            <label><input type="radio" name="P3_Q30" value="B"> huge population in the market</label>
            <label><input type="radio" name="P3_Q30" value="C"> bursting demand</label>
            <label><input type="radio" name="P3_Q30" value="D"> artistic design</label>
          </div>
        </div>

        <h3 style="margin-top:16px">Questions 31â€“35</h3>
        <p>YES if the statement is true â€” NO if it is false â€” NOT GIVEN if the information is not in the passage.</p>

        <div class="qblock" id="q31" data-type="single" data-answer="YES">
          <p><strong>31.</strong> Some automakers mislead and suppressed the real demand for electric cars of keeping profit in a certain market by luring the want of CARB.</p>
          <div class="options">
            <label><input type="radio" name="P3_Q31" value="YES"> YES</label>
            <label><input type="radio" name="P3_Q31" value="NO"> NO</label>
            <label><input type="radio" name="P3_Q31" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <div class="qblock" id="q32" data-type="single" data-answer="NO">
          <p><strong>32.</strong> Toyota started to sell 328 RAV4-EVs for taking up the market share.</p>
          <div class="options">
            <label><input type="radio" name="P3_Q32" value="YES"> YES</label>
            <label><input type="radio" name="P3_Q32" value="NO"> NO</label>
            <label><input type="radio" name="P3_Q32" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <div class="qblock" id="q33" data-type="single" data-answer="YES">
          <p><strong>33.</strong> In some countries, American automakers would like to grab the opportunity to earn money in bigger-engine cars rather than smaller ones.</p>
          <div class="options">
            <label><input type="radio" name="P3_Q33" value="YES"> YES</label>
            <label><input type="radio" name="P3_Q33" value="NO"> NO</label>
            <label><input type="radio" name="P3_Q33" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <div class="qblock" id="q34" data-type="single" data-answer="NO">
          <p><strong>34.</strong> Hybrid cars are superior vehicles that combine an eco-friendly electric engine and a lower price per unit.</p>
          <div class="options">
            <label><input type="radio" name="P3_Q34" value="YES"> YES</label>
            <label><input type="radio" name="P3_Q34" value="NO"> NO</label>
            <label><input type="radio" name="P3_Q34" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <div class="qblock" id="q35" data-type="single" data-answer="YES">
          <p><strong>35.</strong> An inspiration to produce hybrid cars was to cope with economic difficulties from GMâ€™s declining market.</p>
          <div class="options">
            <label><input type="radio" name="P3_Q35" value="YES"> YES</label>
            <label><input type="radio" name="P3_Q35" value="NO"> NO</label>
            <label><input type="radio" name="P3_Q35" value="NOT GIVEN"> NOT GIVEN</label>
          </div>
        </div>

        <h3 style="margin: top 16pxpx">Questions 36â€“40</h3>
        <p>Complete the summary using the list of words below. <em>(Drag a chip into each blank.)</em></p>

        <div class="bank" id="bank">
          <span class="chip" draggable="true" data-key="A">A. electric car</span>
          <span class="chip" draggable="true" data-key="B">B. United Kingdom</span>
          <span class="chip" draggable="true" data-key="C">C. Market</span>
          <span class="chip" draggable="true" data-key="D">D. concept car</span>
          <span class="chip" draggable="true" data-key="E">E. longer distances</span>
          <span class="chip" draggable="true" data-key="F">F. Emissions</span>
          <span class="chip" draggable="true" data-key="G">G. battery</span>
          <span class="chip" draggable="true" data-key="H">H. Consumers</span>
          <span class="chip" draggable="true" data-key="I">I. gasoline-electricity</span>
          <span class="chip" draggable="true" data-key="J">J. inspiration</span>
          <span class="chip" draggable="true" data-key="K">K. cargo space</span>
          <span class="chip" draggable="true" data-key="L">L. orientation</span>
        </div>

        <div class="qblock" id="q36to40">
          <p>
            A <span class="drop" id="drop36" data-answer="D" data-label="36">36</span>
            was firstly introduced by car maker Toyota in 1995. Then it started for sale in 1997 with a new first-generation model.
            Not only in Japan but included other countries such as
            <span class="drop" id="drop37" data-answer="B" data-label="37">37</span>
            and Oceania in which the Prius was imported to. The first-generation Prius was the first car in mass production which is powered by
            <span class="drop" id="drop38" data-answer="I" data-label="38">38</span>.
          </p>
          <p>
            The model NHW10 was designed by a winning Californian designer. The innovated NHW11 Prius has considerably higher running velocity and
            <span class="drop" id="drop39" data-answer="E" data-label="39">39</span>
            than American counterparts. Still, the load capacity of current Prius version was limited in its
            <span class="drop" id="drop40" data-answer="K" data-label="40">40</span>.
          </p>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn" id="resetDD">Reset</button>
          </div>
        </div>

        <footer class="nav">
          <a class="btn ghost" href="readingp1.html">Passage 1</a>
          <a class="btn ghost" href="readingp2.html">Passage 2</a>
          <a class="btn active" href="readingp3.html" aria-current="page">Passage 3</a>
        </footer>
        <button class="btn primary" id="proceedBtn">Proceed to Writing</button>
      </aside>
    </div>
  </div>
</main>

<script>
/* ===== Theme toggle ===== */
(function(){
  const toggle=document.getElementById('themeToggle');
  if(!toggle) return;
  const saved=localStorage.getItem('sp_theme')||'light';
  document.documentElement.setAttribute('data-theme', saved);
  toggle.checked=(saved==='dark');
  toggle.addEventListener('change',()=>{
    const mode=toggle.checked?'dark':'light';
    document.documentElement.setAttribute('data-theme', mode);
    localStorage.setItem('sp_theme', mode);
  });
})();

/* ===== Highlighter (yellow/green + eraser) â€” layout-safe ===== */
(function(){
  function wrap(color){
    const sel=window.getSelection();
    if(!sel || sel.isCollapsed) return;
    const range=sel.getRangeAt(0);
    const span=document.createElement('span');
    span.className='hl '+(color==='yellow'?'hl-yellow':'hl-green');
    try{ range.surroundContents(span); }catch{}
    sel.removeAllRanges();
  }
  function erase(){
    const sel=window.getSelection();
    if(!sel || sel.isCollapsed) return;
    const range=sel.getRangeAt(0);
    document.querySelectorAll('#passage span.hl').forEach(el=>{
      try{
        if(range.intersectsNode(el)){
          const p=el.parentNode;
          while(el.firstChild) p.insertBefore(el.firstChild, el);
          p.removeChild(el);
          p.normalize();
        }
      }catch{}
    });
    sel.removeAllRanges();
  }
  document.querySelectorAll('[data-hl]')
    .forEach(b=>b.addEventListener('click',()=>wrap(b.dataset.hl)));
  const er=document.getElementById('hl-eraser');
  if(er) er.addEventListener('click', erase);
})();

/* ===== GLOBAL: collect & snapshot ALL answers into localStorage ===== */
(function(){
  function collectAll(){
    const a={};
    // radios
    document.querySelectorAll('input[type=radio]:checked').forEach(el=>{ a[el.name]=el.value; });
    // selects
    document.querySelectorAll('select').forEach(el=>{ a[el.id||el.name||`sel_${Math.random().toString(36).slice(2)}`]=el.value; });
    // text/textarea
    document.querySelectorAll('input[type=text], textarea').forEach(el=>{ a[el.id||el.name||`txt_${Math.random().toString(36).slice(2)}`]=el.value; });
    // drag & drop
    ['drop36','drop37','drop38','drop39','drop40'].forEach(id=>{ const chip=document.querySelector('#'+id+' .chip'); a[id]=chip?chip.dataset.key:''; });

    // Optional: include which passage/page this is
    a.__page='reading_p3';

    const iso=new Date().toISOString();
    localStorage.setItem('sp_reading_answers', JSON.stringify(a));
    localStorage.setItem('sp_reading_saved_at', iso);
    // Also store a page-specific bundle with pretty keys
    const pageBundle={
      page:'reading_p3',
      savedAt: iso,
      answers:{
        P3_Q27:a['P3_Q27']||'', P3_Q28:a['P3_Q28']||'', P3_Q29:a['P3_Q29']||'', P3_Q30:a['P3_Q30']||'',
        P3_Q31:a['P3_Q31']||'', P3_Q32:a['P3_Q32']||'', P3_Q33:a['P3_Q33']||'', P3_Q34:a['P3_Q34']||'', P3_Q35:a['P3_Q35']||'',
        drop36:a['drop36']||'', drop37:a['drop37']||'', drop38:a['drop38']||'', drop39:a['drop39']||'', drop40:a['drop40']||''
      }
    };
    localStorage.setItem('sp_reading_p3', JSON.stringify(pageBundle));
  }
  // expose
  window.__sp_collectReadingAnswers = collectAll;

  // background & catch-all autosave hooks
  const snapshot=()=>{ try{ collectAll(); }catch{} };
  window.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='hidden') snapshot(); });
  window.addEventListener('pagehide', snapshot);
  window.addEventListener('beforeunload', snapshot);
  document.addEventListener('change', snapshot, true);
})();

/* ===== Persist per-field (P3_*) ===== */
(function(){
  // Helper generates consistent keys WITHOUT double prefix
  const keyFor=(raw)=>{
    const base = raw || '';
    return base.startsWith('P3_') ? base : ('P3_'+base);
  };

  // text + textarea
  document.querySelectorAll('input[type=text], textarea').forEach(el=>{
    const rawKey=(el.id||el.name||('txt_'+Math.random().toString(36).slice(2)));
    const key=keyFor(rawKey);
    if(!el.dataset.key) el.dataset.key=key;
    el.value = localStorage.getItem(key) || '';
    el.addEventListener('input',()=>{ localStorage.setItem(key, el.value); if(window.__sp_collectReadingAnswers) window.__sp_collectReadingAnswers(); });
  });

  // radios (store one key per group)
  document.querySelectorAll('input[type=radio]').forEach(el=>{
    const key=keyFor(el.name||el.id||'radio');
    const saved=localStorage.getItem(key);
    if(saved===el.value) el.checked=true;
    el.addEventListener('change',()=>{ if(el.checked){ localStorage.setItem(key, el.value); if(window.__sp_collectReadingAnswers) window.__sp_collectReadingAnswers(); } });
  });

  // selects
  document.querySelectorAll('select').forEach(el=>{
    const key=keyFor(el.id||el.name||'sel');
    const saved=localStorage.getItem(key);
    if(saved!==null) el.value=saved;
    el.addEventListener('change',()=>{ localStorage.setItem(key, el.value); if(window.__sp_collectReadingAnswers) window.__sp_collectReadingAnswers(); });
  });
})();

/* ===== Question nav: smooth jump & active highlight ===== */
(function(){
  const qnav=document.getElementById('qnav');
  const pane=document.getElementById('questions');
  if(!qnav||!pane) return;
  qnav.addEventListener('click',e=>{
    const btn=e.target.closest('button[data-q]');
    if(!btn) return;
    const target=document.getElementById(btn.dataset.q);
    if(target){ pane.scrollTo({top: target.offsetTop-8, behavior:'smooth'}); }
    qnav.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
})();

function pulseBox(qid){
  const btn=document.querySelector(`.qnav button[data-q="${qid}"]`);
  if(!btn) return;
  btn.classList.add('pulse');
  setTimeout(()=>btn.classList.remove('pulse'),650);
}

/* ===== Green â€œdoneâ€ markers for Q27â€“35 (no card flash) ===== */
(function(){
  const map={
    q27:'input[name="P3_Q27"]', q28:'input[name="P3_Q28"]', q29:'input[name="P3_Q29"]', q30:'input[name="P3_Q30"]',
    q31:'input[name="P3_Q31"]', q32:'input[name="P3_Q32"]', q33:'input[name="P3_Q33"]', q34:'input[name="P3_Q34"]', q35:'input[name="P3_Q35"]'
  };
  const qnav=document.getElementById('qnav');
  if(!qnav) return;
  const btnFor=id=>qnav.querySelector(`button[data-q="${id}"]`);
  function update(id){
    const btn=btnFor(id); if(!btn) return;
    const sel=map[id];
    const done=!!document.querySelector(sel+':checked');
    btn.classList.toggle('done', done);
  }
  Object.entries(map).forEach(([qid, sel])=>{
    document.querySelectorAll(sel).forEach(r=>{
      r.addEventListener('change',()=>{
        const box=document.getElementById(qid);
        const ans=(box?.dataset.answer||'').trim();
        update(qid);
        if(ans && r.value===ans) pulseBox(qid);
        if(window.__sp_collectReadingAnswers) window.__sp_collectReadingAnswers();
      });
    });
  });
  // initial
  setTimeout(()=>Object.keys(map).forEach(update),0);
})();

/* ===== Drag & Drop for 36â€“40 (with save & correct pulse) ===== */
(function(){
  const bank=document.getElementById('bank');
  const drops=[36,37,38,39,40].map(n=>document.getElementById('drop'+n));
  const LS='P3_DD_';

  function chipByKey(key){
    return bank.querySelector(`.chip[data-key="${key}"]`) || document.querySelector(`.chip[data-key="${key}"]`);
  }
  function wire(chip){
    chip.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain', chip.dataset.key);
      e.dataTransfer.effectAllowed='move';
      chip.classList.add('dragging');
    });
    chip.addEventListener('dragend',()=>chip.classList.remove('dragging'));
  }
  bank.querySelectorAll('.chip').forEach(wire);

  function markDone(qid, on){
    const b=document.querySelector(`.qnav button[data-q="${qid}"]`);
    if(b) b.classList.toggle('done', !!on);
  }
  function fill(dz, key){
    const existing=dz.querySelector('.chip');
    if(existing) bank.appendChild(existing);
    const chip=chipByKey(key); if(!chip) return;
    dz.textContent='';
    dz.appendChild(chip);
    dz.classList.add('filled');
    const ok=(dz.dataset.answer===key);
    dz.classList.toggle('dd-correct', ok);
    if(ok) pulseBox(dz.id.replace('drop','q'));
    localStorage.setItem(LS+dz.id, key);
    markDone(dz.id.replace('drop','q'), true);
    if(window.__sp_collectReadingAnswers) window.__sp_collectReadingAnswers();
  }
  function clear(dz){
    const c=dz.querySelector('.chip');
    if(c) bank.appendChild(c);
    dz.classList.remove('filled','dd-correct');
    dz.textContent=dz.dataset.label;
    localStorage.removeItem(LS+dz.id);
    markDone(dz.id.replace('drop','q'), false);
    if(window.__sp_collectReadingAnswers) window.__sp_collectReadingAnswers();
  }

  drops.forEach(dz=>{
    dz.addEventListener('dragover',e=>e.preventDefault());
    dz.addEventListener('drop',e=>{ e.preventDefault(); const key=e.dataTransfer.getData('text/plain'); if(key) fill(dz,key); });
    dz.addEventListener('dblclick',()=>clear(dz));
  });

  // restore (from per-drop keys)
  drops.forEach(dz=>{
    const saved=localStorage.getItem(LS+dz.id);
    if(saved) fill(dz, saved); else dz.textContent=dz.dataset.label;
  });

  // controls
  document.getElementById('resetDD').addEventListener('click',()=>drops.forEach(clear));
})();

/* ===== Footer nav should actually navigate (and save first) ===== */
(function(){
  document.querySelectorAll('footer.nav a').forEach(a=>{
    a.addEventListener('click', e=>{
      e.preventDefault();
      if(window.__sp_collectReadingAnswers) window.__sp_collectReadingAnswers();
      window.location.href = a.getAttribute('href');
    });
  });
})();

/* ===== Ensure timer badge exists in header ===== */
(function(){
  if(!document.getElementById('timer')){
    const badge=document.createElement('span');
    badge.id='timer';
    badge.className='timer';
    badge.textContent='60:00';
    const header=document.querySelector('.appbar');
    const meta=document.querySelector('.appbar .meta');
    if(header) header.insertBefore(badge, meta||null);
  }
})();

/* ===== Reading global 60-minute countdown (persists across passages) ===== */
(function(){
  const DMS=60*60*1000; // 60 minutes
  const END='sp_reading_end_ts';
  const DONE='sp_reading_done';
  const timer=document.getElementById('timer');

  let end=parseInt(localStorage.getItem(END)||'0',10);
  const now=Date.now();
  if(!end || end<now){
    end=now+DMS;
    localStorage.setItem(END, String(end));
    localStorage.removeItem(DONE);
  }

  const fmt=n=>String(n).padStart(2,'0');
  function tick(){
    if(localStorage.getItem(DONE)==='1'){ redirect(); return; }
    const remain=(parseInt(localStorage.getItem(END)||String(end),10))-Date.now();
    if(remain<=0){ if(timer) timer.textContent='00:00'; finalizeAndRedirect(); return; }
    const sec=Math.floor(remain/1000);
    const m=Math.floor(sec/60), s=sec%60;
    if(timer) timer.textContent=`${fmt(m)}:${fmt(s)}`;
    setTimeout(tick,250);
  }

  function finalizeAndRedirect(){
    try{ document.querySelectorAll('input, select, textarea, button').forEach(el=>{ if(el.id!=='themeToggle') el.disabled=true; }); }catch{}
    if(window.__sp_collectReadingAnswers) window.__sp_collectReadingAnswers();
    localStorage.setItem('sp_reading_submitted_at', new Date().toISOString());
    localStorage.setItem(DONE,'1');
    setTimeout(redirect,300);
  }
  function redirect(){ window.location.href='writing.html'; }

  tick();
})();

/* ===== Proceed button: save ALL answers, then go to writing ===== */
(function(){
  function proceed(){
    if(window.__sp_collectReadingAnswers) window.__sp_collectReadingAnswers();
    localStorage.setItem('sp_reading_done','1');
    localStorage.setItem('sp_reading_submitted_at', new Date().toISOString());
    window.location.href='writing.html';
  }
  const btn=document.getElementById('proceedBtn');
  if(btn) btn.addEventListener('click', proceed);
})();
</script>
</body>
</html>