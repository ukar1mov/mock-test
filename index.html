<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>sevenplus ‚Äî CD IELTS (Listening Test)</title>

  <link rel="icon" href="./favicon/favicon-180.png" type="image/png">
  <link rel="apple-touch-icon" href="./icons/favicon-180.png" sizes="180x180">
  <meta name="theme-color" content="#1aa2c9">

  <style>
    :root{ --brand-blue:#1aa2c9; --brand-gray:#55595c; --bg:#f7f9fb; --panel:#fff; --text:#0f172a; --line:#e5e8eb; }
    [data-theme="dark"]{ --bg:#0e1116; --panel:#141922; --text:#e6edf3; --line:#2a2f38; }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto}

    .appbar{position:sticky;top:0;z-index:20;background:var(--panel);border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;padding:10px 16px;}
    .logo-text{font-size:1.2rem;text-decoration:none}
    .meta{margin-left:auto;display:flex;gap:10px;align-items:center}

    main{max-width:1000px;margin:22px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:22px;box-shadow:0 8px 24px rgba(0,0,0,.05)}
    .screen{display:none}
    .screen.active{display:block}
    .spacer{height:12px}

    .btn{border:1px solid var(--line);background:var(--panel);padding:.55rem .9rem;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:var(--brand-blue)}
    .btn.primary{background:var(--brand-blue);color:#fff;border-color:var(--brand-blue)}
    .btn.lg{padding:.7rem 1.1rem;font-weight:600}

    #screen-welcome .card{display:grid;gap:14px;background:linear-gradient(135deg, rgba(26,162,201,.06), transparent), var(--panel)}
    .field{display:flex;flex-direction:column;gap:6px}
    .field input{padding:.7rem .8rem;border:1px solid var(--line);border-radius:12px}

    table.form-table, .matrix-table, .ref-table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    table.form-table th,table.form-table td{border-top:1px solid var(--line);padding:10px;vertical-align:top}
    table.form-table th{background:rgba(26,162,201,.08);text-align:left}
    table.form-table tr:first-child th, table.form-table tr:first-child td{border-top:none}
    input.answer{width:auto;max-width:100%;padding:.45rem .6rem;border:1px solid var(--line);border-radius:10px;display:inline-block;margin:0 6px;vertical-align:middle}
    small.note{color:#667085}
    .mcq{border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:12px;background:var(--panel)}
    .mcq h4{margin:0 0 8px 0}
    .options{display:grid;gap:8px;margin-top:8px}
    .options label{display:flex;gap:8px;align-items:flex-start}
    .mcq + .mcq{margin-top:16px}
    .mcq ul li{margin:10px 0}

    .toolbar{display:flex;gap:10px;align-items:center;border:1px dashed var(--line);padding:8px;border-radius:10px;margin:10px 0}
    .toolbar.sticky{position:sticky;top:56px;z-index:5;background:var(--panel);box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .toolbar-label{font-weight:600;color:#64707d}
    .swatch{width:22px;height:22px;border:1px solid var(--line);border-radius:6px;padding:0;cursor:pointer;display:inline-block;appearance:none;-webkit-appearance:none;outline:none;box-shadow:none;background:transparent}
    .swatch.yellow{background:#fff59d}
    .swatch.green{background:#c8e6c9}
    .swatch:focus{outline:2px solid var(--brand-blue);outline-offset:2px}
    .icon-btn{width:34px;height:34px;display:inline-grid;place-items:center;border:1px solid var(--line);background:var(--panel);border-radius:8px;cursor:pointer;font-size:18px;line-height:1;padding:0;}
    .icon-btn:hover{border-color:var(--brand-blue)}
    .hl{background:#fff59d;border-radius:2px;-webkit-box-decoration-break:clone;box-decoration-break:clone}
    .hl[data-hl="green"]{background:#c8e6c9}

    .legend{padding:12px;border-radius:12px;border:1px solid var(--line);background:var(--panel)}
    .legend .row{display:flex;justify-content:center;gap:22px;flex-wrap:wrap;font-weight:600;margin-top:6px}
    .legend .row .item{display:flex;align-items:baseline;gap:8px}
    .legend .row .item strong{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:var(--brand-blue);color:#fff;border:1px solid var(--brand-blue);font-weight:800;}

    .qnav{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0 0 0}
    .qbtn{min-width:30px;height:30px;padding:0 8px;border:1px solid var(--line);border-radius:8px;background:var(--panel);cursor:pointer;font-weight:600}
    .qbtn:hover{border-color:var(--brand-blue)}
    .qbtn.active{background:var(--brand-blue);color:#fff;border-color:var(--brand-blue)}
    .qbtn.answered{background:#16a34a;color:#fff;border-color:#16a34a}
    @keyframes flashGreen{from{box-shadow:0 0 0 0 rgba(22,163,74,.8)} to{box-shadow:0 0 0 12px rgba(22,163,74,0)}}
    .qbtn.flash{animation:flashGreen .8s ease-out 1}

    footer.part-nav{display:flex;gap:8px;justify-content:center;margin-top:14px}
    .part-nav .btn.active{background:#38bdf8;border-color:#38bdf8;color:#0b1224;font-weight:700}
    @keyframes flashBlue{from{box-shadow:0 0 0 0 rgba(56,189,248,.9)} to{box-shadow:0 0 0 14px rgba(56,189,248,0)}}
    .part-nav .btn.flash{animation:flashBlue .8s ease-out 1}

    /* Matching (generic) */
    .match-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:8px}
    @media (max-width: 800px){.match-grid{grid-template-columns:1fr}}
    .left{display:grid;gap:10px}
    .match-row{display:grid;grid-template-columns:1fr 1fr 36px;gap:10px;align-items:center}
    .facility{padding:.6rem .75rem;border:1px dashed var(--line);border-radius:10px;background:var(--panel)}
    .drop-slot{min-height:50px;border:2px dashed var(--line);border-radius:10px;background:rgba(26,162,201,.06);display:flex;align-items:center;justify-content:flex-start;padding:6px 8px;gap:8px}
    .drop-slot.filled{border-color:#16a34a;background:rgba(22,163,74,.08)}
    .slot-content{width:100%;border:1px dashed rgba(56,189,248,.9);background:rgba(56,189,248,.10);padding:6px 8px;border-radius:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;word-break:break-word}
    .slot-remove{margin-left:auto;border:none;background:transparent;color:#64707d;cursor:pointer;font-size:16px;line-height:1}
    .pill{display:inline-grid;place-items:center;min-width:26px;height:26px;border-radius:8px;background:var(--brand-blue);color:#fff;font-weight:700;border:1px solid var(--brand-blue)}
    .token-bank{display:grid;gap:8px}
    .token{padding:.55rem .65rem;border:1px solid var(--line);border-radius:10px;background:var(--panel);cursor:grab;user-select:none}
    .token:active{cursor:grabbing}
    .token.assigned{opacity:.75}

    .note.muted{color:#64707d}
   /* 15‚Äì20: two-column layout with compact question list */
.map-qa { display:grid; grid-template-columns:1.2fr 1fr; gap:14px; align-items:start; }
@media (max-width:900px){ .map-qa { grid-template-columns:1fr; } }

.map-wrap{border:1px solid var(--line);border-radius:12px;background:var(--panel);padding:10px}
.map-wrap img{display:block;width:100%;height:auto;border-radius:8px;cursor:zoom-in}
.map-wrap img.zoom{cursor:zoom-out;transform:scale(1.9);transform-origin:center;transition:transform .2s ease}
.map-caption{font-size:.9rem;color:#64707d;margin-top:6px;text-align:center}

/* Compact questions (each row shows current letter; picker on click) */
.q15-list{display:grid;gap:8px}
.q15-row{display:flex;gap:8px;align-items:center;border:1px dashed var(--line);padding:8px;border-radius:10px;background:var(--panel)}
.q15-name{flex:1}
.q15-pick{min-width:36px;height:30px;border:1px solid var(--line);border-radius:8px;background:var(--panel);cursor:pointer;font-weight:700}
.q15-pick.filled{background:#16a34a;color:#fff;border-color:#16a34a}

/* Letter picker (A‚ÄìJ) */
.letter-picker{display:none;position:sticky;top:66px;z-index:6;border:1px solid var(--line);background:var(--panel);
  border-radius:12px;padding:10px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
.letter-picker.active{display:block}
.letter-grid{display:grid;grid-template-columns:repeat(5, minmax(38px,1fr));gap:8px}
.letter-btn{height:36px;border:1px solid var(--line);background:var(--panel);border-radius:10px;cursor:pointer;font-weight:800}
.letter-btn:hover{border-color:var(--brand-blue)}

/* rows already exist */
.q15-row{position:relative}          /* so the popover anchors to the row */
.q15-pick{min-width:36px;height:30px;border:1px solid var(--line);border-radius:8px;background:var(--panel);cursor:pointer;font-weight:700}
.q15-pick.filled{background:#16a34a;color:#fff;border-color:#16a34a}

/* inline popover */
.picker-pop{
  position:absolute; z-index:30; left:0; top:100%;
  margin-top:6px; padding:8px;
  border:1px solid var(--line); background:var(--panel); border-radius:12px;
  box-shadow:0 10px 28px rgba(0,0,0,.10);
}
.picker-grid{display:grid;grid-template-columns:repeat(5, minmax(34px,1fr));gap:8px}
.picker-btn{height:34px;border:1px solid var(--line);background:var(--panel);border-radius:10px;cursor:pointer;font-weight:800}
.picker-btn:hover{border-color:var(--brand-blue)}
.q15-row input.answer {
  display: none !important;
}
  </style>
</head>
<body>
<header class="appbar">
  <span class="logo-text"><strong style="color:var(--brand-blue)">seven</strong><strong style="color:var(--brand-gray)">plus</strong></span>
  <div class="meta">
    <label class="switch" style="display:flex;align-items:center;gap:8px;cursor:pointer">
      <input id="themeToggle" type="checkbox" /><span>üåì</span>
    </label>
  </div>
</header>

<main>
  <!-- WELCOME -->
  <section id="screen-welcome" class="screen active">
    <div class="card">
      <div>
        <h1 style="margin:0 0 6px 0;font-size:1.6rem">
          <strong style="color:var(--brand-blue)">seven</strong><strong style="color:var(--brand-gray)">plus</strong> ‚Äî CD IELTS
        </h1>
        <p style="margin:0 0 8px 0;color:#64707d">Please enter your details. Listening Part 1 will start automatically.</p>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <label class="field">Full name
          <input id="fullName" type="text" placeholder="e.g., Ulug'bek Karimov" />
        </label>
        <label class="field">Candidate number
          <input id="candidateNumber" type="text" inputmode="numeric" placeholder="e.g., SP0101" />
        </label>
      </div>
      <div class="spacer"></div>
      <div style="display:flex;justify-content:center;margin-top:12px">
        <button id="startBtn" class="btn primary lg">Start test</button>
      </div>
    </div>
  </section>
<!----jhflahjlfdsajjlfd-->
  <!-- LISTENING -->
  <section id="screen-listening" class="screen">
    <div class="card">
      <div class="section-header"><h2>Listening</h2></div>

      <!-- Highlighter -->
      <div class="toolbar sticky" id="hlToolbar">
        <span class="toolbar-label">Highlighter:</span>
        <button class="swatch yellow" data-hl="yellow" aria-label="Yellow highlight" title="Highlight (yellow)"></button>
        <button class="swatch green"  data-hl="green"  aria-label="Green highlight" title="Highlight (green)"></button>
        <button class="icon-btn" id="clearHighlights" title="Erase selected/current highlight" aria-label="Erase highlight">üßΩ</button>
      </div>

      <audio id="audio" autoplay preload="auto" playsinline muted>
        <source src="./audio/audio.mp3" type="audio/mpeg" />
      </audio>

      <!-- PART 1 -->
      <div id="part1">
        <h3 style="display:flex;align-items:center;gap:10px;margin-bottom:8px">Part 1
          <span style="font-weight:500;color:#64707d">Listen and answer questions 1‚Äì10</span>
        </h3>
        <p><em>Questions 1‚Äì10</em> ‚Äî Write <strong>ONE WORD AND/OR A NUMBER</strong> for each answer.</p>

        <div class="card" style="padding:0;border-radius:12px">
          <div style="padding:16px 16px 0 16px">
            <h4 style="margin:0 0 6px 0">Volunteer work application form: <em>Grace Brown</em></h4>
          </div>
          <table class="form-table">
            <tbody>
              <tr><th style="width:32%">Mobile phone number</th><td>021 636 7189</td></tr>
              <tr><th>Email address</th><td>graceb@ <input id="L1" class="answer" placeholder="1" style="max-width:200px" /> .co.nz</td></tr>
              <tr><th>Qualification</th><td>a diploma in <input id="L2" class="answer" placeholder="2" style="max-width:220px" /></td></tr>
              <tr><th>Agreed work hours</th><td>from <input id="L3" class="answer" placeholder="3" style="max-width:120px" /> to 2 pm Monday to Friday</td></tr>
              <tr><th>Volunteer work experience</th><td>
                <ul style="margin:0 0 0 18px">
                  <li>A volunteer city <input id="L4" class="answer" placeholder="4" style="max-width:220px" /></li>
                  <li>A volunteer netball team <input id="L5" class="answer" placeholder="5" style="max-width:220px" /></li>
                  <li>At Rugby World Cup</li>
                </ul>
              </td></tr>
              <tr><th>Hobbies</th><td>
                <ul style="margin:0 0 0 18px">
                  <li>Likes to work in her <input id="L6" class="answer" placeholder="6" style="max-width:220px" /></li>
                  <li>Enjoys flowers arranging</li>
                  <li>Plays the <input id="L7" class="answer" placeholder="7" style="max-width:220px" /></li>
                </ul>
              </td></tr>
              <tr><th>Type of work offered</th><td>
                <ul style="margin:0 0 0 18px">
                  <li>Working on a <input id="L8" class="answer" placeholder="8" style="max-width:220px" /> ‚Äî for a month</li>
                  <li>Working in a community centre with elderly people</li>
                </ul>
              </td></tr>
              <tr><th>Why is she interested in volunteering?</th><td>
                <ul style="margin:0 0 0 18px">
                  <li>Wants to have more <input id="L9" class="answer" placeholder="9" style="max-width:220px" /></li>
                  <li>Wants to help others</li>
                </ul>
              </td></tr>
              <tr><th>Where did she hear about the agency?</th><td> Saw an advertisement at the <input id="L10" class="answer" placeholder="10" style="max-width:240px" /></td></tr>
            </tbody>
          </table>
          <div style="padding:0 16px 16px 16px"><small class="note">Answers autosave in your browser.</small></div>
        </div>

        <div class="qnav" aria-label="Question navigation 1-10">
          <button class="qbtn" data-target="L1">1</button><button class="qbtn" data-target="L2">2</button>
          <button class="qbtn" data-target="L3">3</button><button class="qbtn" data-target="L4">4</button>
          <button class="qbtn" data-target="L5">5</button><button class="qbtn" data-target="L6">6</button>
          <button class="qbtn" data-target="L7">7</button><button class="qbtn" data-target="L8">8</button>
          <button class="qbtn" data-target="L9">9</button><button class="qbtn" data-target="L10">10</button>
        </div>
      </div>

      <!-- PART 2 -->
      <div id="part2" style="display:none">
        <h3>Part 2</h3>
        <p><em>Questions 11‚Äì20</em>. Listen and answer the questions below.</p>

        <!-- 11‚Äì14 MCQ -->
        <p><strong>Questions 11‚Äì14</strong> ‚Äî Choose the correct letter, A, B or C. <em>Talk to new employees at a strawberry farm</em></p>
        <div class="mcq"><h4>11. What should employees bring to work?</h4>
          <div class="options">
            <label><input type="radio" name="L11" value="A"> gloves</label>
            <label><input type="radio" name="L11" value="B"> lunch</label>
            <label><input type="radio" name="L11" value="C"> water</label>
          </div>
        </div>
        <div class="mcq"><h4>12. If employees can't come to work one day, they should</h4>
          <div class="options">
            <label><input type="radio" name="L12" value="A"> contact the duty manager.</label>
            <label><input type="radio" name="L12" value="B"> leave a phone message at the farm office.</label>
            <label><input type="radio" name="L12" value="C"> call their team leader.</label>
          </div>
        </div>
        <div class="mcq"><h4>13. One problem with customers that may occur now is that</h4>
          <div class="options">
            <label><input type="radio" name="L13" value="A"> they sometimes fail to return baskets.</label>
            <label><input type="radio" name="L13" value="B"> they eat the fruit before paying.</label>
            <label><input type="radio" name="L13" value="C"> they can be unsure about prices.</label>
          </div>
        </div>
        <div class="mcq"><h4>14. Training staff to use fire extinguishers correctly</h4>
          <div class="options">
            <label><input type="radio" name="L14" value="A"> employees‚Äô friends are entitled to a small discount.</label>
            <label><input type="radio" name="L14" value="B"> employees can have a quantity of fresh fruit for free.</label>
            <label><input type="radio" name="L14" value="C"> employees don‚Äôt pay full price for gift items in the shop.</label>
          </div>
        </div>

        <!-- 15‚Äì20 matching (letters A‚ÄìJ) -->
        <div class="mcq">
          <h4 style="margin-bottom:6px">Questions 15‚Äì20</h4>
          <p style="margin-top:0">Look at the <em>Map of strawberry farm</em>. For each place (15‚Äì20), choose a letter <strong>A‚ÄìJ</strong>.
          </p>
        
          <div class="map-qa">
            <!-- Left: MAP -->
            <div class="map-wrap">
              <img id="strawberryMap" src="./images/map.png" alt="Map of strawberry farm with areas A‚ÄìJ marked" />
              <div class="map-caption">Map of strawberry farm (letters A‚ÄìJ)</div>
            </div>
        
            <!-- Right: compact questions + hidden inputs for autosave -->
            <div>
              <!-- the small letter picker (appears when you click 15‚Äì20 or row) -->
              <div id="letterPicker" class="letter-picker" aria-label="Pick a letter A‚ÄìJ">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                  <strong>Choose letter</strong>
                  <span id="pickerFor" class="note">for Q15</span>
                  <button id="pickerClear" class="btn" style="margin-left:auto">Clear</button>
                </div>
                <div class="letter-grid" id="letterGrid"></div>
              </div>
        
              <div class="q15-list" id="q15List">
                <!-- each row has a tiny button to show current letter; click opens picker -->
                <div class="q15-row" data-q="L15">
                  <div class="q15-name">15. Staff room</div>
                  <button class="q15-pick" data-qbtn>‚Äî</button>
                  <input id="L15" class="answer" type="text" style="display:none" />
                </div>
                <div class="q15-row" data-q="L16">
                  <div class="q15-name">16. Administration</div>
                  <button class="q15-pick" data-qbtn>‚Äî</button>
                  <input id="L16" class="answer" type="text" hidden />
                </div>
                <div class="q15-row" data-q="L17">
                  <div class="q15-name">17. Packing shed</div>
                  <button class="q15-pick" data-qbtn>‚Äî</button>
                  <input id="L17" class="answer" type="text" hidden />
                </div>
                <div class="q15-row" data-q="L18">
                  <div class="q15-name">18. Staff car park</div>
                  <button class="q15-pick" data-qbtn>‚Äî</button>
                  <input id="L18" class="answer" type="text" hidden />
                </div>
                <div class="q15-row" data-q="L19">
                  <div class="q15-name">19. Ripe strawberries</div>
                  <button class="q15-pick" data-qbtn>‚Äî</button>
                  <input id="L19" class="answer" type="text" hidden />
                </div>
                <div class="q15-row" data-q="L20">
                  <div class="q15-name">20. Unripe strawberries</div>
                  <button class="q15-pick" data-qbtn>‚Äî</button>
                  <input id="L20" class="answer" type="text" hidden />
                </div>
                <small class="note">Tip: press the number buttons 15‚Äì20 below to open the picker as well.</small>
              </div>
            </div>
          </div>
        </div>
        

        <div class="qnav" aria-label="Question navigation 11-20">
          <button class="qbtn" data-target="L11">11</button><button class="qbtn" data-target="L12">12</button>
          <button class="qbtn" data-target="L13">13</button><button class="qbtn" data-target="L14">14</button>
          <button class="qbtn" data-target="L15">15</button><button class="qbtn" data-target="L16">16</button>
          <button class="qbtn" data-target="L17">17</button><button class="qbtn" data-target="L18">18</button>
          <button class="qbtn" data-target="L19">19</button><button class="qbtn" data-target="L20">20</button>
        </div>
      </div>

      <!-- PART 3 -->
      <div id="part3" style="display:none">
        <h3>Part 3</h3>
        <p><em>Questions 21‚Äì30</em>. <em>Kathy‚Äôs dissertation on water pumps</em></p>

        <!-- 21‚Äì26 MCQ -->
        <p><strong>Questions 21‚Äì26</strong> ‚Äî Choose the correct letter, A, B or C.</p>
        <div class="mcq"><h4>21. What part of Kathy‚Äôs dissertation has the tutor just read?</h4>
          <div class="options">
            <label><input type="radio" name="L21" value="A"> her results section</label>
            <label><input type="radio" name="L21" value="B"> her introductory chapter</label>
            <label><input type="radio" name="L21" value="C"> her review of the literature</label>
          </div>
        </div>
        <div class="mcq"><h4>22. What did the tutor like about Kathy‚Äôs work?</h4>
          <div class="options">
            <label><input type="radio" name="L22" value="A"> the organization</label>
            <label><input type="radio" name="L22" value="B"> the style of writing</label>
            <label><input type="radio" name="L22" value="C"> the use of resources</label>
          </div>
        </div>
        <div class="mcq"><h4>23. Kathy and the tutor agree that she needs to</h4>
          <div class="options">
            <label><input type="radio" name="L23" value="A"> do some more library research</label>
            <label><input type="radio" name="L23" value="B"> record more data</label>
            <label><input type="radio" name="L23" value="C"> narrow down her topic</label>
          </div>
        </div>
        <div class="mcq"><h4>24. Why does the tutor give an example from his own experience?</h4>
          <div class="options">
            <label><input type="radio" name="L24" value="A"> to show how successful he has become</label>
            <label><input type="radio" name="L24" value="B"> to illustrate how times have changed</label>
            <label><input type="radio" name="L24" value="C"> to encourage Kathy to do something similar</label>
          </div>
        </div>
        <div class="mcq"><h4>25. Kathy would like the tutor to advise her on her</h4>
          <div class="options">
            <label><input type="radio" name="L25" value="A"> layout</label>
            <label><input type="radio" name="L25" value="B"> bibliography</label>
            <label><input type="radio" name="L25" value="C"> appendices</label>
          </div>
        </div>
        <div class="mcq"><h4>26. What is Kathy going to do next?</h4>
          <div class="options">
            <label><input type="radio" name="L26" value="A"> try out some software</label>
            <label><input type="radio" name="L26" value="B"> go to a seminar</label>
            <label><input type="radio" name="L26" value="C"> design a new type of pump</label>
          </div>
        </div>

        <!-- 27‚Äì30 matching (A‚ÄìF) -->
        <div class="mcq">
          <h4 style="margin-bottom:6px">Questions 27‚Äì30</h4>
          <p>How will Kathy benefit from doing each of the following activities? Choose FOUR answers from the box and write the correct letter, <strong>A‚ÄìF</strong>, next to the activities.</p>
          <div class="match-grid">
            <div class="left">
              <div class="match-row"><div class="facility">27. Going to Mechanical Engineers‚Äô Society meetings</div><div class="drop-slot" data-q="L27"></div><div>27</div></div>
              <div class="match-row"><div class="facility">28. Visiting different workplaces</div><div class="drop-slot" data-q="L28"></div><div>28</div></div>
              <div class="match-row"><div class="facility">29. Getting some work experience abroad</div><div class="drop-slot" data-q="L29"></div><div>29</div></div>
              <div class="match-row"><div class="facility">30. Attending an international conference</div><div class="drop-slot" data-q="L30"></div><div>30</div></div>
            </div>
            <div class="right">
              <div id="bank27" class="token-bank" data-letters="A-F">
                <div class="token" data-letter="A" draggable="true"><strong>A.</strong> broadens practical experience of the field</div>
                <div class="token" data-letter="B" draggable="true"><strong>B.</strong> chance to publicise own work</div>
                <div class="token" data-letter="C" draggable="true"><strong>C.</strong> effective way to keeping up-to-date</div>
                <div class="token" data-letter="D" draggable="true"><strong>D.</strong> looks good on a CV</div>
                <div class="token" data-letter="E" draggable="true"><strong>E.</strong> provides useful access to resources</div>
                <div class="token" data-letter="F" draggable="true"><strong>F.</strong> way to make useful contacts</div>
              </div>
              <small class="note">Drag a letter to each activity.</small>
            </div>
          </div>
        </div>

        <div class="qnav" aria-label="Question navigation 21-30">
          <button class="qbtn" data-target="L21">21</button><button class="qbtn" data-target="L22">22</button>
          <button class="qbtn" data-target="L23">23</button><button class="qbtn" data-target="L24">24</button>
          <button class="qbtn" data-target="L25">25</button><button class="qbtn" data-target="L26">26</button>
          <button class="qbtn" data-target="L27">27</button><button class="qbtn" data-target="L28">28</button>
          <button class="qbtn" data-target="L29">29</button><button class="qbtn" data-target="L30">30</button>
        </div>
      </div>

      <!-- PART 4 -->
      <div id="part4" style="display:none">
        <h3>Part 4</h3>
        <p><em>Questions 31‚Äì40</em>. <em>American Salt Marshes & Horseshoe Crab</em></p>

        <div class="mcq">
          <h4 style="margin-bottom:6px">Questions 31‚Äì34</h4>
          <p>Write <strong>ONE WORD ONLY</strong> for each answer.</p>
          <ul style="margin:0;padding-left:18px;list-style:disc">
            <li>31 The salt content in marshes can be as high as that of the <input id="L31" class="answer" placeholder="31" style="max-width:220px" />.</li>
            <li>32 At different times of the day, there are changes in salinity and the <input id="L32" class="answer" placeholder="32" style="max-width:220px" /> and warmth of the water.</li>
            <li>33 Animals such as worms and shrimps feed on the <input id="L33" class="answer" placeholder="33" style="max-width:220px" /> that grow in the marsh.</li>
            <li>34 Marshland in the US has been used in the past for <input id="L34" class="answer" placeholder="34" style="max-width:220px" /> cultivation.</li>
          </ul>
        </div>

        <div class="mcq">
          <h4 style="margin-bottom:6px">Questions 35‚Äì38</h4>
          <p>Choose the correct letter, A, B or C.</p>
          <div class="options">
            <p><strong>35</strong> The speaker says that one result of erecting artificial walls in salt marshes is that</p>
            <label><input type="radio" name="L35" value="A"> water levels can get too high.</label>
            <label><input type="radio" name="L35" value="B"> wildlife has less space.</label>
            <label><input type="radio" name="L35" value="C"> water quality is difficult to control.</label>
          </div><hr>
          <div class="options">
            <p><strong>36</strong> Some people have complained about the building of dikes because</p>
            <label><input type="radio" name="L36" value="A"> access for workers is reduced.</label>
            <label><input type="radio" name="L36" value="B"> the insect population has increased.</label>
            <label><input type="radio" name="L36" value="C"> the natural beauty of the area is affected.</label>
          </div><hr>
          <div class="options">
            <p><strong>37</strong> In the 20th century, a large proportion of marshes in America became</p>
            <label><input type="radio" name="L37" value="A"> salt extraction sites</label>
            <label><input type="radio" name="L37" value="B"> residential areas</label>
            <label><input type="radio" name="L37" value="C"> protected insect reserves</label>
          </div><hr>
          <div class="options">
            <p><strong>38</strong> There are now laws which help to prevent</p>
            <label><input type="radio" name="L38" value="A"> the erosion of soil</label>
            <label><input type="radio" name="L38" value="B"> the building of more walls</label>
            <label><input type="radio" name="L38" value="C"> the extinction of sea life</label>
          </div>
        </div>

        <div class="mcq">
          <h4 style="margin-bottom:6px">Questions 39‚Äì40</h4>
          <p>Write <strong>NO MORE THAN TWO WORDS</strong> for each answer. <em>Horseshoe Crab</em></p>
          <ul style="margin:0;padding-left:18px;list-style:disc">
            <li>Most common food: <input id="L39" class="answer" placeholder="39" style="max-width:260px" /></li>
            <li>Time of year when female lays eggs: <input id="L40" class="answer" placeholder="40" style="max-width:260px" /></li>
          </ul>
        </div>

        <div class="qnav" aria-label="Question navigation 31-40">
          <button class="qbtn" data-target="L31">31</button><button class="qbtn" data-target="L32">32</button>
          <button class="qbtn" data-target="L33">33</button><button class="qbtn" data-target="L34">34</button>
          <button class="qbtn" data-target="L35">35</button><button class="qbtn" data-target="L36">36</button>
          <button class="qbtn" data-target="L37">37</button><button class="qbtn" data-target="L38">38</button>
          <button class="qbtn" data-target="L39">39</button><button class="qbtn" data-target="L40">40</button>
        </div>

        <div class="spacer"></div>
        <button class="btn primary" id="toReading">Proceed to Reading module</button>
      </div>

      <footer class="part-nav">
        <button class="btn" data-part="1">Part 1</button>
        <button class="btn" data-part="2">Part 2</button>
        <button class="btn" data-part="3">Part 3</button>
        <button class="btn" data-part="4">Part 4</button>
      </footer>
    </div>
  </section>

  <section id="screen-reading" class="screen" style="display:none">
    <div class="card">
      <h2>Reading ‚Äì Module</h2>
      <p class="note muted">Click ‚ÄúProceed to Reading module‚Äù above. This placeholder exists only for future inline mode.</p>
    </div>
  </section>
</main>

<script>
/* ========= Welcome / Start flow ========= */
(function startFlow(){
  const startBtn = document.getElementById('startBtn');
  if(!startBtn) return;
  const nameEl = document.getElementById('fullName');
  const numEl  = document.getElementById('candidateNumber');

  const cachedName = localStorage.getItem('sp_candidate_name');
  const cachedNum  = localStorage.getItem('sp_candidate_number');
  if (cachedName) nameEl.value = cachedName;
  if (cachedNum)  numEl.value  = cachedNum;

  startBtn.addEventListener('click', ()=>{
    const name = (nameEl?.value || '').trim();
    const num  = (numEl?.value  || '').trim();
    if (!name || !num) {
      alert('Please fill in both fields.');
      (name ? numEl : nameEl)?.focus();
      return;
    }
    localStorage.setItem('sp_candidate_name', name);
    localStorage.setItem('sp_candidate_number', num);
    localStorage.setItem('sp_test_started_at', new Date().toISOString());

    document.getElementById('screen-welcome')?.classList.remove('active');
    document.getElementById('screen-listening')?.classList.add('active');

    ['1','2','3','4'].forEach(n => {
      const p = document.getElementById('part'+n);
      if (p) p.style.display = (n === '1') ? 'block' : 'none';
    });

    const a = document.getElementById('audio');
    if (a){ a.muted = false; a.currentTime = 0; a.play().catch(()=>{}); }

    document.getElementById('L1')?.focus();
    startBtn.disabled = true; setTimeout(()=> startBtn.disabled = false, 800);
  });
})();

/* ========= Persistence (text inputs + radios) ========= */
(function persistence(){
  const fields = document.querySelectorAll('input.answer:not([type="radio"]):not([type="checkbox"]), textarea.answer');
  fields.forEach(el=>{
    const id = el.id || el.name; if(!id) return;
    const key = 'sp_' + id;
    const saved = localStorage.getItem(key);
    if(saved !== null) el.value = saved;
    const save = () => localStorage.setItem(key, el.value);
    el.addEventListener('input', save);
    el.addEventListener('change', save);
    el.addEventListener('blur', save);
  });

  const radioGroups = new Map();
  document.querySelectorAll('input[type="radio"][name]').forEach(r=>{
    radioGroups.set(r.name, true);
  });
  radioGroups.forEach((_, name)=>{
    const saved = localStorage.getItem('sp_'+name) || '';
    if (saved) {
      const toCheck = document.querySelector('input[type="radio"][name="'+name+'"][value="'+saved+'"]');
      if (toCheck) toCheck.checked = true;
    }
    document.querySelectorAll('input[type="radio"][name="'+name+'"]').forEach(r=>{
      r.addEventListener('change', ()=> localStorage.setItem('sp_'+name, r.value));
    });
  });
})();

/* ========= Part navigation ========= */
(function partNav(){
  const audioEl = document.getElementById('audio');
  const sections = { '1':'part1','2':'part2','3':'part3','4':'part4' };
  const buttons = document.querySelectorAll('footer.part-nav .btn[data-part]');

  const setActive = (p) => {
    buttons.forEach(b=> b.classList.toggle('active', b.getAttribute('data-part')===p));
    Object.entries(sections).forEach(([k,id])=>{
      const sec = document.getElementById(id);
      if (sec) sec.style.display = (k===p) ? 'block' : 'none';
    });
    if (audioEl) audioEl.play().catch(()=>{});
  };

  buttons.forEach(b=>{
    b.addEventListener('click', ()=>{
      setActive(b.getAttribute('data-part'));
      b.classList.add('flash');
      b.addEventListener('animationend', ()=> b.classList.remove('flash'), {once:true});
    });
  });
  setActive('1');
})();

/* ========= Global question navs (answered state + jump) ========= */
(function qNavs(){
  function findTarget(id){
    let el = document.getElementById(id); if(el) return el;
    el = document.querySelector('input[type="radio"][name="'+id+'"]'); if(el) return el;
    el = document.querySelector('.drop-slot[data-q="'+id+'"]'); if(el) return el;
    return null;
  }
  function isAnswered(id){
    const t = document.getElementById(id); if(t) return (t.value||'').trim().length>0;
    const r = document.querySelector('input[type="radio"][name="'+id+'"]:checked'); if(r) return true;
    const s = document.querySelector('.drop-slot[data-q="'+id+'"]'); if(s) return !!s.querySelector('.slot-content');
    return false;
  }

  document.querySelectorAll('.qnav').forEach(nav=>{
    const btns = [...nav.querySelectorAll('.qbtn')];
    const ids  = btns.map(b=> b.getAttribute('data-target'));
    btns.forEach((b,i)=>{ if(isAnswered(ids[i])) b.classList.add('answered'); });

    btns.forEach((b,i)=>{
      const id = ids[i];
      b.addEventListener('click', ()=>{
        btns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active','flash');
        b.addEventListener('animationend', ()=> b.classList.remove('flash'), {once:true});
        const t = findTarget(id);
        if (t){ t.scrollIntoView({behavior:'smooth', block:'center'}); try{ t.focus({preventScroll:true}); }catch{} }
      });
    });

    ids.forEach(id=>{
      const t = document.getElementById(id);
      if (t) t.addEventListener('input', ()=>{
        const b = nav.querySelector('[data-target="'+id+'"]');
        const filled = (t.value||'').trim().length>0;
        b.classList.toggle('answered', filled);
        if(filled){ b.classList.add('flash'); b.addEventListener('animationend', ()=> b.classList.remove('flash'), {once:true}); }
      });

      document.querySelectorAll('input[type=radio][name="'+id+'"]').forEach(r=> r.addEventListener('change', ()=>{
        const b = nav.querySelector('[data-target="'+id+'"]');
        b.classList.add('answered','flash'); b.addEventListener('animationend', ()=> b.classList.remove('flash'), {once:true});
      }));

      const s = document.querySelector('.drop-slot[data-q="'+id+'"]');
      if (s){
        const obs = new MutationObserver(()=>{
          const b=nav.querySelector('[data-target="'+id+'"]');
          const filled=!!s.querySelector('.slot-content');
          b.classList.toggle('answered', filled);
          if(filled){ b.classList.add('flash'); b.addEventListener('animationend', ()=> b.classList.remove('flash'), {once:true}); }
        });
        obs.observe(s,{childList:true,subtree:true});
      }
    });
  });
})();

/* ========= Generic drag & drop initializer ========= */
function initMatching(bankId, slotQs){
  const bank = document.getElementById(bankId); if(!bank) return;
  const slots = slotQs.map(q => document.querySelector('.drop-slot[data-q="'+q+'"]'));

  // order tokens by letter
  [...bank.querySelectorAll('.token')]
    .sort((a,b)=> a.dataset.letter.localeCompare(b.dataset.letter))
    .forEach(t=> bank.appendChild(t));

  let selectedToken = null;

  bank.addEventListener('click', e=>{
    const t = e.target.closest('.token'); if(!t) return;
    selectedToken = t;
    bank.querySelectorAll('.token').forEach(k=>k.classList.remove('active'));
    t.classList.add('active');
  });

  slots.forEach(s=> s.addEventListener('click', ()=>{
    if (selectedToken){ placeToken(selectedToken, s); selectedToken.classList.remove('active'); selectedToken=null; }
  }));

  bank.querySelectorAll('.token').forEach(t=>{
    t.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', t.dataset.letter));
  });

  slots.forEach(s=>{
    s.addEventListener('dragover', e=>{ e.preventDefault(); s.classList.add('drag'); });
    s.addEventListener('dragleave', ()=> s.classList.remove('drag'));
    s.addEventListener('drop', e=>{
      e.preventDefault(); s.classList.remove('drag');
      const letter = e.dataTransfer.getData('text/plain');
      const token  = bank.querySelector('.token[data-letter="'+letter+'"]');
      if (token) placeToken(token, s);
    });
  });

  function clearSlot(slot){
    const content = slot.querySelector('.slot-content');
    if(content){
      const letter = content.dataset.letter;
      const t = bank.querySelector('.token[data-letter="'+letter+'"]');
      if (t){ t.classList.remove('assigned'); bank.appendChild(t); }
      content.remove();
      slot.classList.remove('filled');
      persist();
    }
  }

  function placeToken(token, slot){
    // unique per letter
    const used = document.querySelector('.slot-content[data-letter="'+token.dataset.letter+'"]');
    if (used) clearSlot(used.closest('.drop-slot'));
    // clear current slot
    if (slot.querySelector('.slot-content')) clearSlot(slot);

    const wrap = document.createElement('div');
    wrap.className = 'slot-content';
    wrap.dataset.letter = token.dataset.letter;

    const pill = document.createElement('span'); pill.className='pill'; pill.textContent = token.dataset.letter;
    const text = document.createElement('span'); text.textContent = token.textContent.replace(/^\s*[A-Z]\.\s*/,'').trim();
    const rem  = document.createElement('button'); rem.className='slot-remove'; rem.setAttribute('title','Remove'); rem.innerHTML='&times;';
    rem.addEventListener('click', ()=> clearSlot(slot));

    wrap.appendChild(pill); wrap.appendChild(text); wrap.appendChild(rem);
    slot.appendChild(wrap);
    slot.classList.add('filled');

    token.classList.add('assigned');
    persist();

    slot.animate([{boxShadow:'0 0 0 0 rgba(22,163,74,.8)'},{boxShadow:'0 0 0 16px rgba(22,163,74,0)'}],{duration:600,easing:'ease-out'});
  }

  function persist(){
    const map = {};
    slots.forEach(s=>{
      const q=s.dataset.q; const c=s.querySelector('.slot-content');
      map[q] = c ? c.dataset.letter : '';
    });
    Object.entries(map).forEach(([k,v])=> localStorage.setItem('sp_'+k, v));
  }

  (function restore(){
    slotQs.forEach(q=>{
      const letter = localStorage.getItem('sp_'+q) || '';
      if (!letter) return;
      const token = bank.querySelector('.token[data-letter="'+letter+'"]');
      const slot  = document.querySelector('.drop-slot[data-q="'+q+'"]');
      if (token && slot) placeToken(token, slot);
    });
  })();
}

/* init the two matching blocks */
initMatching('bank15', ['L15','L16','L17','L18','L19','L20']);
initMatching('bank27', ['L27','L28','L29','L30']);

/* ========= Highlighter + targeted eraser (same) ========= */
(function highlighter(){
  let lastRange = null;
  function snapshot(){ const sel = window.getSelection(); if (sel && sel.rangeCount && !sel.isCollapsed) lastRange = sel.getRangeAt(0).cloneRange(); }
  document.addEventListener('selectionchange', snapshot);
  ['mouseup','keyup'].forEach(evt => document.addEventListener(evt, snapshot, true));

  function unwrap(node){ if(!node || !node.parentNode) return; const p = node.parentNode; while(node.firstChild) p.insertBefore(node.firstChild, node); p.removeChild(node); }
  function rangeIntersectsElement(range, el){ const r = document.createRange(); r.selectNodeContents(el); return range.compareBoundaryPoints(Range.END_TO_START, r) < 0 && range.compareBoundaryPoints(Range.START_TO_END, r) > 0; }
  function isFormCtrl(el){ return !!(el && el.closest('input,textarea,button,select,.answer')); }
  function getCommonBlock(aNode, bNode){
    const A = (aNode.nodeType===1 ? aNode : aNode.parentElement);
    const B = (bNode.nodeType===1 ? bNode : bNode.parentElement);
    if (!A || !B) return null;
    const blockSel = 'th,td,p,li,blockquote,div,h1,h2,h3,h4,h5,h6';
    const ca = A.closest(blockSel); const cb = B.closest(blockSel);
    return (ca && cb && ca === cb) ? ca : null;
  }
  function applyHighlight(color){
    const sel = window.getSelection();
    let range = (sel && sel.rangeCount && !sel.isCollapsed) ? sel.getRangeAt(0).cloneRange()
              : (lastRange ? lastRange.cloneRange() : null);
    if (!range) return;

    const sc = (range.startContainer.nodeType===1 ? range.startContainer : range.startContainer.parentElement);
    const ec = (range.endContainer.nodeType===1   ? range.endContainer   : range.endContainer.parentElement);
    if (isFormCtrl(sc) || isFormCtrl(ec)) return;

    const container = getCommonBlock(range.startContainer, range.endContainer);
    if (!container) return;

    const tw = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, {
      acceptNode: (n) => n.nodeValue.trim().length ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT
    });

    const bg = (color === 'green') ? '#c8e6c9' : '#fff59d';
    const slices = [];

    while (tw.nextNode()){
      const node = tw.currentNode;
      if (node.parentElement && node.parentElement.matches('span.hl')) continue;
      if (!rangeIntersectsElement(range, node.parentElement)) continue;

      let start = 0, end = node.nodeValue.length;
      if (node === range.startContainer && range.startOffset > start) start = range.startOffset;
      if (node === range.endContainer   && range.endOffset   < end)   end   = range.endOffset;
      if (start >= end) continue;

      slices.push({node,start,end});
    }

    const startHL = sc && sc.closest('span.hl');
    const endHL   = ec && ec.closest('span.hl');
    if (startHL && endHL && startHL === endHL && rangeIntersectsElement(range, startHL)){
      startHL.dataset.hl = color; startHL.style.background = bg; return;
    }

    for (let i = slices.length - 1; i >= 0; i--){
      const {node,start,end} = slices[i];
      const mid = node.splitText(start);
      mid.splitText(end - start);
      const span = document.createElement('span');
      span.className = 'hl'; span.dataset.hl = color; span.style.background = bg;
      mid.parentNode.replaceChild(span, mid); span.appendChild(mid);
    }

    document.querySelectorAll('span.hl').forEach(h=>{
      const n = h.nextSibling, p = h.previousSibling;
      if (n && n.nodeType===1 && n.matches('span.hl') && n.dataset.hl===h.dataset.hl){ while (n.firstChild) h.appendChild(n.firstChild); n.remove(); }
      if (p && p.nodeType===1 && p.matches('span.hl') && p.dataset.hl===h.dataset.hl){ while (h.firstChild) p.appendChild(h.firstChild); h.remove(); }
    });
  }

  function swatchHandler(e){
    const btn = e.target.closest('[data-hl]'); if (!btn) return;
    e.preventDefault(); e.stopPropagation(); applyHighlight(btn.getAttribute('data-hl'));
  }
  document.addEventListener('pointerdown', swatchHandler, true);
  document.addEventListener('mousedown',  swatchHandler, true);
  document.addEventListener('click',      swatchHandler, true);

  (function bindEraser(){
    const old = document.getElementById('clearHighlights'); if(!old) return;
    const btn = old.cloneNode(true); old.replaceWith(btn); btn.id='clearHighlights';

    function intersects(range, el){ const r = document.createRange(); r.selectNodeContents(el); return range.compareBoundaryPoints(Range.END_TO_START, r) < 0 && range.compareBoundaryPoints(Range.START_TO_END, r) > 0; }

    btn.addEventListener('click', ()=>{
      const sel = window.getSelection();
      if (sel && !sel.isCollapsed){
        const r = sel.getRangeAt(0);
        document.querySelectorAll('span.hl').forEach(s=>{ if (intersects(r, s)) unwrap(s); });
        sel.removeAllRanges();
        return;
      }
      let node = (sel && sel.anchorNode) ? sel.anchorNode : document.activeElement;
      if (node && node.nodeType === 3) node = node.parentElement;
      const target = node && node.closest ? node.closest('span.hl') : null;
      if (target) unwrap(target);
    });

    document.addEventListener('click', (e)=>{
      if (!e.altKey) return;
      const hl = e.target.closest && e.target.closest('span.hl');
      if (hl){ e.preventDefault(); unwrap(hl); }
    }, true);
  })();
})();

/* ========= Theme toggle ========= */
(function theme(){
  const themeToggle = document.getElementById('themeToggle');
  if(!themeToggle) return;
  const saved = localStorage.getItem('sp_theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved);
  themeToggle.checked = saved === 'dark';
  themeToggle.addEventListener('change', ()=>{
    const mode = themeToggle.checked ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', mode);
    localStorage.setItem('sp_theme', mode);
  });
})();

/* ========= Misc ========= */
document.querySelectorAll('input').forEach(el => el.setAttribute('autocomplete','off'));
(function attemptAutoplay(){
  const a=document.getElementById('audio'); if(!a) return;
  const play=()=>a.play().catch(()=>{});
  if(document.readyState==='complete' || document.readyState==='interactive') play();
  else document.addEventListener('DOMContentLoaded', play);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') play(); });
})();
(function goReading(){
  const btn = document.getElementById('toReading'); if(!btn) return;
  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    const a=document.getElementById('audio'); if(a){a.pause(); a.currentTime=0;}
    window.location.href='readingp1.html';
  });
})();
if (location.protocol === 'file:') {
  try { console.warn('Running from file:// ‚Äî each file has its own LocalStorage. Serve via http://localhost so pages share storage.'); } catch {}
}
// Click-to-zoom map
(function(){
  const m = document.getElementById('strawberryMap');
  if(m){ m.addEventListener('click', ()=> m.classList.toggle('zoom')); }
})();

/* Q15‚Äì20 inline picker (click the box ‚Üí letters show ‚Üí pick ‚Üí auto-close) */
(function(){
  const letters = 'A,B,C,D,E,F,G,H,I,J'.split(',');
  const qs = ['L15','L16','L17','L18','L19','L20'];
  let open = null; // {pop, q, btn}

  function storageKey(q){ return 'sp_'+q; }
  function updateBtn(btn, val){ btn.textContent = val || '‚Äî'; btn.classList.toggle('filled', !!val); }
  function markAnswered(q){
    const val = (document.getElementById(q)?.value || '').trim();
    const nb = document.querySelector(`.qnav [data-target="${q}"]`);
    if(nb){
      nb.classList.toggle('answered', !!val);
      if(val){ nb.classList.add('flash'); nb.addEventListener('animationend', ()=> nb.classList.remove('flash'), {once:true}); }
    }
  }
  function closePop(){ if(open){ open.pop.remove(); open=null; } }

  function buildPopover(q, btn){
    closePop();
    const pop = document.createElement('div');
    pop.className = 'picker-pop';
    const grid = document.createElement('div');
    grid.className = 'picker-grid';
    letters.forEach(L=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'picker-btn';
      b.textContent = L;
      b.addEventListener('click', ()=>{
        const inp = document.getElementById(q);
        inp.value = L;
        localStorage.setItem(storageKey(q), L);
        updateBtn(btn, L);
        markAnswered(q);
        closePop();
      });
      grid.appendChild(b);
    });
    pop.appendChild(grid);
    return pop;
  }

  // Wire each row
  qs.forEach(q=>{
    const row = document.querySelector(`.q15-row[data-q="${q}"]`);
    if(!row) return;
    const btn = row.querySelector('[data-qbtn]');
    const inp = document.getElementById(q);

    // restore saved
    const saved = localStorage.getItem(storageKey(q)) || '';
    if(saved){ inp.value = saved; updateBtn(btn, saved); markAnswered(q); }

    // clicking the box opens the inline picker
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      // create and attach
      const pop = buildPopover(q, btn);
      row.appendChild(pop);
      open = {pop, q, btn};
    });

    // clicking anywhere else on the row can also open it (optional)
    row.addEventListener('click', (e)=>{
      if(e.target.closest('.q15-pick')) return; // already handled
      btn.click();
    });

    // number buttons 15‚Äì20 open the picker too
    const nb = document.querySelector(`.qnav [data-target="${q}"]`);
    if(nb){ nb.addEventListener('click', ()=> btn.click()); }
  });

  // close on outside click / Esc
  document.addEventListener('click', ()=> closePop());
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closePop(); });
})();

</script>
</body>
</html>
